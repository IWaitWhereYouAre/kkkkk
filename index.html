<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <meta name="theme-color" content="#FFFBF4" />
  <title>Heart to Heart | ISA Chulalongkorn</title>

  <!-- html2canvas (works on iOS/Android/Desktop; saving handled with robust fallback below) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
          integrity="sha512-BNa5lR0o8q+4d2mWcP1bB7P0P0qQ7Qy0cJQ8o0c5o6WmU6xF2w0o3oWqv3bW0oZxkqQw6xj9tq8u0p1p0Q=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&family=Pinyon+Script&display=swap');

    /* =========================
       GLOBAL TOKENS (NO BLACK)
       ========================= */
    :root{
      --ink: #3A2430;            /* deep wine-ink (not black) */
      --porcelain: #FFFBF4;      /* warm cream */
      --cream: #F8F5F0;
      --cream-2: #FBF3E6;
      --champagne: #F3E4C8;

      /* Deep Wine + Gold (Act I) */
      --wine: #5A0F1B;
      --wine-2: #7B1E2B;
      --rose: #B21E35;
      --gold: #D4AF37;
      --old-gold: #C9A24A;
      --ivory: #FFF2DF;

      /* Garden (Act II) */
      --deep-green: #1A2A1D;
      --sage: #E6EFE7;
      --blush: #E8D5D1;

      /* RGB helpers */
      --wine-rgb: 90,15,27;
      --wine2-rgb: 123,30,43;
      --rose-rgb: 178,30,53;
      --gold-rgb: 212,175,55;
      --green-rgb: 26,42,29;

      /* =========================
         ACT A ‚Äî VALENTINE REDS (NO GREEN)
         ========================= */
      --val-crimson: #C3163A;
      --val-wine:    #5A0F1B;
      --val-velvet:  #7A0624;

      --valentine-grad: linear-gradient(135deg,
        var(--val-crimson) 0%,
        var(--val-wine) 50%,
        var(--val-velvet) 100%
      );

      --valentine-glow: radial-gradient(780px 520px at 50% 26%,
        rgba(195,22,58,0.34),
        rgba(90,15,27,0.00) 66%
      );

      /* App base (overridden per view) */
      --bg: var(--porcelain);
      --fg: var(--ink);
      --card: rgba(255,255,255,0.62);
      --stroke: rgba(58,36,48,0.12);
      --shadow: 0 22px 60px rgba(58,36,48,0.14);

      /* Safe-area */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* Reduce motion accessibility */
    @media (prefers-reduced-motion: reduce){
      * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    html, body{
      width:100%; height:100%;
      margin:0; padding:0;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Lato', sans-serif;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
      touch-action: manipulation;
      overscroll-behavior: none;
    }
    body{
      min-height: 100svh;
      overflow: hidden;
    }

    /* Better tap feel */
    button, [role="button"], .home-card, .trait, .card{
      -webkit-tap-highlight-color: transparent;
    }

    /* App wrapper becomes scroll container */
    #app{
      height: 100svh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
      padding-bottom: var(--safe-bottom);
    }

    .view{
      display:none;
      min-height: 100svh;
      box-sizing: border-box;
      position: relative;
      padding: calc(22px + var(--safe-top)) 20px calc(70px + var(--safe-bottom));
    }
    .view.active{ display:block; }

    /* =========================
       NAV
       ========================= */
    .topbar{
      width: min(1100px, 96vw);
      margin: 0 auto 14px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      position: relative;
      z-index: 30;
    }
    .navbtn{
      border: 1px solid rgba(255,255,255,0.20);
      background: linear-gradient(135deg,
        rgba(255,255,255,0.58),
        rgba(255,255,255,0.34)
      );
      color: rgba(58,36,48,0.92);
      backdrop-filter: blur(14px);
      padding: 11px 14px;
      border-radius: 14px;
      font-size: 0.72rem;
      letter-spacing: 2.2px;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      box-shadow: 0 14px 40px rgba(58,36,48,0.12);
    }
    .navbtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.40);
      box-shadow: 0 18px 50px rgba(58,36,48,0.16);
    }
    .navbtn:focus-visible{
      outline: 2px solid rgba(var(--gold-rgb),0.55);
      outline-offset: 3px;
    }

    /* =========================
       LAYERS (swapped per view)
       ========================= */
    .layer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      display:none;
      transform: translateZ(0);
    }
    .layer.on{ display:block; }

    /* Soft luxury vignette */
    .vignette{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:6;
      background:
        radial-gradient(1200px 800px at 50% 20%, rgba(255,255,255,0.0) 60%, rgba(58,36,48,0.10) 100%),
        radial-gradient(1200px 900px at 50% 120%, rgba(255,255,255,0.0) 58%, rgba(58,36,48,0.12) 100%);
      mix-blend-mode:multiply;
      opacity:0.55;
      display:none;
    }
    .vignette.on{ display:block; }

    /* =========================
       HOME
       ========================= */
    #home{
      --bg: var(--porcelain);
      --fg: var(--ink);
      background:
        radial-gradient(900px 600px at 16% 18%, rgba(var(--gold-rgb),0.22), transparent 62%),
        radial-gradient(880px 620px at 84% 28%, rgba(var(--rose-rgb),0.16), transparent 62%),
        radial-gradient(900px 680px at 32% 88%, rgba(var(--green-rgb),0.10), transparent 62%),
        radial-gradient(900px 700px at 76% 92%, rgba(232,213,209,0.28), transparent 62%),
        linear-gradient(135deg, #FFF9F0 0%, #FFF4E8 55%, #FFFDF7 100%);
    }
    .home-wrap{
      width: min(980px, 94vw);
      margin: 0 auto;
      text-align:center;
      padding-top: 26px;
      position: relative;
      z-index: 10;
    }
    .isa-tag{
      font-size:0.62rem;
      letter-spacing:3.2px;
      margin-bottom:8px;
      opacity:0.78;
      text-transform:uppercase;
      color: rgba(58,36,48,0.72);
    }
    h1.main-title{
      font-family:'Pinyon Script', cursive;
      font-size:clamp(3.2rem, 12vw, 6.2rem);
      margin:0;
      line-height:1.05;
      background: linear-gradient(135deg,
        rgba(var(--gold-rgb),0.98),
        rgba(var(--rose-rgb),0.90),
        rgba(var(--wine2-rgb),0.92)
      );
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      text-shadow: 0 18px 50px rgba(58,36,48,0.10);
    }
    .sub-theme{
      font-family:'Playfair Display', serif;
      font-size:clamp(0.75rem, 2vw, 1.02rem);
      letter-spacing:clamp(4px,1vw,10px);
      text-transform:uppercase;
      margin: 10px 0 22px;
      color: rgba(58,36,48,0.62);
    }
    .home-grid{
      margin: 18px auto 0;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
      width: min(860px, 96vw);
    }
    @media (max-width: 820px){ .home-grid{ grid-template-columns: 1fr; } }
    .home-card{
      text-align:left;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.55);
      background:
        linear-gradient(135deg, rgba(255,255,255,0.74), rgba(255,255,255,0.46));
      backdrop-filter: blur(16px);
      padding: 18px 16px;
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      box-shadow: 0 18px 55px rgba(58,36,48,0.12);
      position: relative;
      overflow:hidden;
    }
    .home-card::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 25% 25%, rgba(var(--gold-rgb),0.22), transparent 55%),
        radial-gradient(circle at 75% 35%, rgba(var(--rose-rgb),0.15), transparent 58%),
        radial-gradient(circle at 55% 80%, rgba(var(--green-rgb),0.10), transparent 60%);
      filter: blur(22px);
      opacity: 0.85;
      transform: rotate(-6deg);
      pointer-events:none;
    }
    .home-card:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.78);
      box-shadow: 0 22px 70px rgba(58,36,48,0.16);
    }
    .home-card:focus-visible{
      outline: 2px solid rgba(var(--gold-rgb),0.55);
      outline-offset: 5px;
    }
    .home-title{
      font-family:'Playfair Display', serif;
      font-size: 1.18rem;
      margin: 0 0 6px;
      color: rgba(58,36,48,0.92);
      position: relative;
      z-index: 2;
    }
    .home-desc{
      margin: 0;
      font-size: 0.86rem;
      line-height: 1.6;
      color: rgba(58,36,48,0.70);
      position: relative;
      z-index: 2;
    }
    .note{
      font-size:0.62rem;
      opacity:0.72;
      letter-spacing:1px;
      line-height:1.4;
      margin-top: 12px;
      color: rgba(58,36,48,0.62);
    }

    /* =========================
       ACT I BACKGROUND
       ========================= */
    #bgA.garden-bg{
      background:
        radial-gradient(980px 720px at 18% 22%, rgba(var(--gold-rgb),0.24), transparent 62%),
        radial-gradient(900px 680px at 82% 32%, rgba(var(--rose-rgb),0.20), transparent 60%),
        radial-gradient(980px 760px at 45% 95%, rgba(var(--gold-rgb),0.14), transparent 62%),
        linear-gradient(135deg, #FFF6F0 0%, #FFE9E1 42%, #FFF8F4 100%);
    }
    #bgA.garden-bg::before{
      content:"";
      position:absolute; inset:-35%;
      background:
        radial-gradient(circle at 22% 28%, rgba(var(--gold-rgb),0.18), transparent 58%),
        radial-gradient(circle at 78% 44%, rgba(var(--rose-rgb),0.16), transparent 62%),
        radial-gradient(circle at 52% 74%, rgba(var(--wine2-rgb),0.10), transparent 68%),
        linear-gradient(120deg,
          rgba(var(--gold-rgb),0.12),
          rgba(var(--wine2-rgb),0.08),
          rgba(var(--rose-rgb),0.08)
        );
      filter: blur(22px);
      opacity:0.95;
      animation: drift 18s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }
    #bgA.garden-bg::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
      opacity:0.20;
      mix-blend-mode:overlay;
    }

    #motesA{ z-index:2; opacity:0.95; overflow:hidden; }
    .heart-mote{
      position:absolute;
      width:28px;
      height:28px;
      filter: drop-shadow(0 10px 20px rgba(58,36,48,0.10));
      opacity:0;
      transform: translate3d(0,0,0);
      animation: heartFloat linear infinite;
      will-change: transform, opacity;
    }
    .heart-mote svg{ width:100%; height:100%; display:block; }

    @keyframes heartFloat{
      0%{ transform: translate3d(var(--x), 112vh, 0) rotate(var(--r)) scale(var(--s)); opacity:0; }
      12%{ opacity:0.70; }
      88%{ opacity:0.55; }
      100%{ transform: translate3d(var(--x2), -18vh, 0) rotate(calc(var(--r) + 14deg)) scale(var(--s)); opacity:0; }
    }
    @keyframes drift{
      0%{transform:translate(-4%,-2%) rotate(-2deg);}
      50%{transform:translate(4%,2%) rotate(2deg);}
      100%{transform:translate(-4%,-2%) rotate(-2deg);}
    }

    /* =========================
       ACT II BACKGROUND
       ========================= */
    #bgB.garden-bg{
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(var(--gold-rgb),0.18), transparent 60%),
        radial-gradient(800px 650px at 80% 30%, rgba(232,213,209,0.26), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(var(--green-rgb),0.10), transparent 55%),
        linear-gradient(120deg, #FFFEFA 0%, #FFF7EB 55%, #FFFDF7 100%);
    }
    #bgB.garden-bg::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.70), transparent 55%),
        radial-gradient(circle at 70% 40%, rgba(255,255,255,0.45), transparent 60%),
        radial-gradient(circle at 50% 70%, rgba(255,255,255,0.35), transparent 65%),
        linear-gradient(120deg, rgba(var(--gold-rgb),0.10), rgba(232,213,209,0.14), rgba(var(--green-rgb),0.08));
      filter:blur(18px);
      opacity:0.9;
      animation:drift 18s ease-in-out infinite;
      transform:translate3d(0,0,0);
    }
    #bgB.garden-bg::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("https://www.transparenttextures.com/patterns/natural-paper.png");
      opacity:0.40;
      mix-blend-mode:multiply;
    }

    #petalsB{ z-index:2; overflow:hidden; }
    .petal{
      position:absolute;
      top:-10%;
      width:10px;
      height:16px;
      border-radius:60% 40% 60% 40%;
      background:rgba(232,213,209,0.62);
      box-shadow:0 0 0 1px rgba(var(--gold-rgb),0.10);
      filter:blur(0.15px);
      animation: fall linear infinite;
      transform: rotate(12deg);
      opacity:0.85;
      will-change: transform, opacity;
    }
    @keyframes fall{
      0%{transform:translate3d(0,-20px,0) rotate(10deg);}
      100%{transform:translate3d(0,120vh,0) rotate(260deg);}
    }

    #birdsB{ z-index:3; overflow:hidden; opacity:0.72; filter:blur(0.1px); }
    .bird{
      position:absolute;
      left:0; top:0;
      width:56px; height:30px;
      opacity:0.60;
      animation: flyDiag linear infinite;
      transform:translate3d(var(--fromX),var(--fromY),0) scale(var(--s,1));
      will-change:transform,opacity;
    }
    @keyframes flyDiag{
      0%{transform:translate3d(var(--fromX),var(--fromY),0) scale(var(--s,1)); opacity:0;}
      10%{opacity:0.70;}
      90%{opacity:0.60;}
      100%{transform:translate3d(var(--toX),var(--toY),0) scale(var(--s,1)); opacity:0;}
    }
    .bird .wing{transform-box:fill-box; transform-origin:center; animation:flap 0.35s ease-in-out infinite;}
    .bird .wing.right{animation-delay:0.02s;}
    @keyframes flap{
      0%{transform:rotate(8deg) scaleY(1);}
      50%{transform:rotate(-18deg) scaleY(0.92);}
      100%{transform:rotate(8deg) scaleY(1);}
    }

    /* =========================
       EXPERIENCE A
       ========================= */
    #expA{
      --bg: transparent;
      --fg: var(--ink);
      color: var(--ink);
      background:
        radial-gradient(980px 640px at 50% 12%, rgba(var(--rose-rgb),0.38), transparent 62%),
        radial-gradient(900px 700px at 18% 28%, rgba(var(--wine2-rgb),0.30), transparent 62%),
        radial-gradient(900px 760px at 82% 30%, rgba(var(--rose-rgb),0.26), transparent 62%),
        radial-gradient(980px 860px at 50% 92%, rgba(var(--wine-rgb),0.18), transparent 68%),
        linear-gradient(135deg, #FFF0F2 0%, #FFE3E8 42%, #FFF7F3 100%);
    }
    #expA .container, #expB .container{
      width:100%;
      max-width:1200px;
      margin: 0 auto;
      text-align:center;
      position: relative;
      z-index: 10;
    }
    #expA .isa-tag, #expB .isa-tag{ color: rgba(58,36,48,0.70); }
    #expA h1.main-title{
      text-shadow: 0 18px 50px rgba(58,36,48,0.10);
      background: var(--valentine-grad);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    #expA .sub-theme{ color: rgba(58,36,48,0.62); }
    #expA .opening-line{
      margin: 12px auto 16px;
      max-width: 760px;
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.12rem, 3.4vw, 1.62rem);
      line-height: 1.45;
      font-style: italic;
      color: rgba(58,36,48,0.88);
    }

    /* ritual bar */
    #expA .ritual-bar{
      width:min(860px, 96vw);
      margin: 10px auto 14px;
      border:1px solid rgba(var(--gold-rgb),0.42);
      border-radius: 999px;
      background:
        linear-gradient(135deg,
          rgba(255,240,245,0.88),
          rgba(255,228,232,0.62)
        );
      backdrop-filter: blur(14px);
      padding:10px 14px;
      box-sizing:border-box;
      position:relative;
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(58,36,48,0.10);
    }
    #expA .ritual-bar::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg,
        rgba(var(--gold-rgb),0.16),
        rgba(var(--rose-rgb),0.10),
        rgba(var(--gold-rgb),0.12)
      );
      opacity:0.9;
      pointer-events:none;
    }
    #expA .steps{
      position:relative;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    #expA .step{
      display:flex; gap:8px; align-items:center;
      opacity:0.55;
      transition: opacity .25s ease;
      color: rgba(58,36,48,0.78);
      min-width:0;
    }
    #expA .step.active{ opacity:1; }
    #expA .step-dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(var(--gold-rgb),0.55);
      background: rgba(var(--gold-rgb),0.14);
      flex:0 0 auto;
    }
    #expA .step.active .step-dot{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.45), rgba(var(--gold-rgb),0.98) 60%, rgba(var(--rose-rgb),0.65) 100%);
      box-shadow: 0 0 0 4px rgba(var(--gold-rgb),0.10);
    }
    #expA .step-label{
      font-size:0.58rem;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #expA .token-top{
      width:min(980px, 96vw);
      margin: 0 auto 10px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    #expA .token-badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px;
      border:1px solid rgba(var(--gold-rgb),0.30);
      border-radius:999px;
      background: linear-gradient(135deg, rgba(255,255,255,0.64), rgba(255,255,255,0.40));
      backdrop-filter: blur(14px);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:0.62rem;
      opacity:0.98;
      color: rgba(58,36,48,0.80);
      box-shadow: 0 18px 55px rgba(58,36,48,0.08);
    }
    #expA .token-dots{ display:inline-flex; gap:6px; }
    #expA .dot{
      width:10px; height:10px;
      border-radius:999px;
      border:1px solid rgba(var(--gold-rgb),0.55);
      background: rgba(var(--gold-rgb),0.10);
    }
    #expA .dot.filled{
      background: rgba(var(--gold-rgb),0.95);
      box-shadow: 0 0 0 4px rgba(var(--gold-rgb),0.10);
    }

    #expA .trait-grid{
      width: min(980px, 96vw);
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
      padding:10px;
      box-sizing:border-box;
    }
    @media (max-width: 900px){ #expA .trait-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    #expA .trait{
      border-radius:16px;
      border:1px solid rgba(var(--gold-rgb),0.22);
      background: linear-gradient(135deg, rgba(255,255,255,0.70), rgba(255,255,255,0.44));
      backdrop-filter: blur(14px);
      padding:14px 14px 12px;
      text-align:left;
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
      min-height: 110px;
      color: rgba(58,36,48,0.92);
      box-shadow: 0 18px 55px rgba(58,36,48,0.10);
      user-select:none;
    }
    #expA .trait::before{
      content:"";
      position:absolute; inset:-45%;
      background:
        radial-gradient(circle at 25% 30%, rgba(var(--gold-rgb),0.16), transparent 58%),
        radial-gradient(circle at 70% 40%, rgba(var(--rose-rgb),0.12), transparent 62%),
        radial-gradient(circle at 55% 80%, rgba(var(--wine2-rgb),0.08), transparent 68%);
      filter: blur(22px);
      opacity:0.8;
      transform: rotate(-6deg);
      pointer-events:none;
    }
    #expA .trait:hover{
      border-color: rgba(var(--gold-rgb),0.42);
      box-shadow: 0 22px 70px rgba(58,36,48,0.14);
      transform: translateY(-1px);
    }
    #expA .trait:focus-visible{
      outline: 2px solid rgba(var(--gold-rgb),0.55);
      outline-offset: 4px;
    }
    #expA .trait-title{
      font-family:'Playfair Display', serif;
      font-size:1.02rem;
      line-height:1.22;
      color: rgba(58,36,48,0.94);
      position: relative;
      z-index:2;
    }
    #expA .trait-sub{
      margin-top:6px;
      font-size:0.62rem;
      letter-spacing:2px;
      text-transform:uppercase;
      opacity:0.76;
      line-height:1.35;
      color: rgba(58,36,48,0.70);
      position: relative;
      z-index:2;
    }
    #expA .trait-meter{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      position: relative;
      z-index:2;
    }
    #expA .trait-meter-label{
      font-size:0.52rem;
      letter-spacing:2px;
      text-transform:uppercase;
      opacity:0.72;
      color: rgba(58,36,48,0.64);
    }
    #expA .token-slots{ display:inline-flex; gap:8px; align-items:center; }
    #expA .slot{
      width:14px; height:14px;
      border-radius:999px;
      border:1px solid rgba(var(--gold-rgb),0.55);
      background: rgba(var(--gold-rgb),0.10);
      position:relative;
      overflow:hidden;
    }
    #expA .slot.on{
      background: radial-gradient(circle at 30% 30%,
        rgba(255,255,255,0.35),
        rgba(var(--gold-rgb),0.95) 55%,
        rgba(var(--rose-rgb),0.70) 100%);
      box-shadow: 0 0 0 4px rgba(var(--gold-rgb),0.10);
    }

    /* Receipt title must match main title exactly (Act A) */
    #expA #a-capture-frame h2{
      background: var(--valentine-grad) !important;
      -webkit-background-clip:text !important;
      background-clip:text !important;
      color: transparent !important;
      text-shadow: 0 18px 50px rgba(58,36,48,0.10) !important;
    }

    #expA .btn, #expB .btn{
      border:1px solid rgba(var(--gold-rgb),0.28);
      padding:10px 18px;
      font-family:'Lato', sans-serif;
      text-transform:uppercase;
      letter-spacing:2px;
      font-size:0.7rem;
      cursor:pointer;
      transition:0.3s;
      min-width: 150px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.70), rgba(255,255,255,0.44));
      color: rgba(58,36,48,0.86);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(58,36,48,0.10);
    }
    #expA .btn:hover, #expB .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 22px 70px rgba(58,36,48,0.14);
      border-color: rgba(var(--gold-rgb),0.44);
    }
    #expA .btn:focus-visible, #expB .btn:focus-visible{
      outline: 2px solid rgba(var(--gold-rgb),0.55);
      outline-offset: 4px;
    }
    #expA .btn-save, #expB .btn-save{
      background: linear-gradient(135deg, rgba(var(--gold-rgb),0.95), rgba(var(--old-gold),0.90));
      border-color: rgba(var(--gold-rgb),0.75);
      color: rgba(58,36,48,0.90);
      font-weight: 800;
    }
    #expA .btn:disabled, #expB .btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }
    #expA .btn-sound.active, #expB .btn-sound.active{
      border-color: rgba(var(--gold-rgb),0.70);
      box-shadow: 0 18px 55px rgba(var(--gold-rgb),0.12);
    }
    #expA .tiny-note{
      font-size:0.62rem;
      opacity:0.70;
      letter-spacing:1px;
      margin-top:10px;
      line-height:1.35;
      color: rgba(58,36,48,0.64);
    }

    #expA .panel{
      width: min(820px, 94vw);
      margin: 0 auto;
      border: 1px solid rgba(var(--gold-rgb),0.26);
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255,255,255,0.70), rgba(255,255,255,0.44));
      backdrop-filter: blur(14px);
      padding: 18px 16px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      box-shadow: 0 22px 70px rgba(58,36,48,0.12);
    }
    #expA .recognition-line{
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.1rem, 3.4vw, 1.7rem);
      line-height: 1.4;
      font-style: italic;
      color: rgba(58,36,48,0.92);
      margin: 10px 0 10px;
    }

    #expA #a-result-screen{ display:none; opacity:0; transition: opacity .35s ease; }
    #expA #a-capture-frame{
      background: rgba(255,255,255,0.78);
      padding: clamp(28px, 5vw, 56px) clamp(18px, 4vw, 38px);
      width: 92vw;
      max-width: 560px;
      margin: 0 auto;
      position: relative;
      box-sizing: border-box;
      border: 1px solid rgba(var(--gold-rgb),0.22);
      box-shadow: 0 30px 70px rgba(58,36,48,0.12);
      background-image:
        radial-gradient(900px 520px at 12% 12%, rgba(var(--gold-rgb),0.14), transparent 60%),
        radial-gradient(800px 520px at 85% 30%, rgba(var(--rose-rgb),0.10), transparent 62%),
        url("https://www.transparenttextures.com/patterns/paper-fibers.png");
      background-blend-mode: screen, screen, normal;
      border-radius: 18px;
      overflow:hidden;
    }
    #expA #a-capture-frame::before{
      content:"";
      position:absolute;
      inset: 15px;
      border: 0.8px solid rgba(var(--gold-rgb),0.50);
      pointer-events:none;
      border-radius: 14px;
    }
    #expA .pill-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top: 10px;
    }
    #expA .pill{
      font-size:0.55rem;
      letter-spacing:2px;
      text-transform:uppercase;
      padding: 8px 10px;
      border: 1px solid rgba(var(--gold-rgb),0.40);
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      color: rgba(58,36,48,0.78);
      backdrop-filter: blur(10px);
    }

    /* =========================
       EXPERIENCE B
       ========================= */
    #expB{
      --bg: var(--porcelain);
      --fg: var(--deep-green);
      color: var(--deep-green);
    }
    #expB .sub-theme{ color: rgba(var(--green-rgb),0.70); }
    #expB h1.main-title{
      text-shadow:none;
      background: linear-gradient(135deg, rgba(var(--green-rgb),0.95), rgba(var(--gold-rgb),0.90));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    #expB .deck-area{
      position:relative;
      height:clamp(260px,40vh,420px);
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      perspective:1000px;
      margin-top: 10px;
    }
    #expB .card{
      position:absolute;
      width:clamp(120px,25vw,180px);
      height:clamp(170px,35vh,260px);
      border-radius:14px;
      cursor:pointer;
      transition:all 0.8s cubic-bezier(0.2,1,0.3,1);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(58,36,48,0.10);
      border: 1px solid rgba(var(--gold-rgb),0.22);
      background: linear-gradient(135deg, rgba(255,255,255,0.80), rgba(255,255,255,0.50));
      backdrop-filter: blur(10px);
    }
    #expB .card::after{
      content:'';
      position:absolute;
      inset:10px;
      border-radius:12px;
      border:1px solid rgba(var(--gold-rgb),0.55);
      background:
        radial-gradient(800px 520px at 20% 18%, rgba(var(--gold-rgb),0.12), transparent 60%),
        radial-gradient(760px 560px at 75% 30%, rgba(232,213,209,0.18), transparent 60%),
        radial-gradient(760px 620px at 45% 90%, rgba(var(--green-rgb),0.08), transparent 62%),
        url("https://www.transparenttextures.com/patterns/paper-fibers.png");
      background-blend-mode: screen, screen, screen, normal;
    }
    #expB .card-crest{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      color: rgba(var(--gold-rgb),0.85);
      font-family:'Playfair Display',serif;
      font-size:2.2rem;
      z-index:2;
      opacity:0.75;
      pointer-events:none;
      text-shadow: 0 18px 40px rgba(58,36,48,0.10);
    }

    #expB #b-result-screen{ display:none; opacity:0; transition:opacity .6s ease;}
    #expB #b-capture-frame{
      background: rgba(255,255,255,0.82);
      padding:clamp(26px,4.5vw,56px) clamp(18px,4vw,40px);
      width:min(92vw, 460px);
      margin:0 auto;
      position:relative;
      box-sizing:border-box;
      border:1px solid rgba(var(--gold-rgb),0.22);
      box-shadow: 0 30px 70px rgba(58,36,48,0.10);
      background-image:url("https://www.transparenttextures.com/patterns/paper-fibers.png");
      border-radius: 18px;
      overflow:hidden;
    }
    #expB #b-capture-frame::before{
      content:"";
      position:absolute;
      inset:14px;
      border:0.8px solid rgba(var(--gold-rgb),0.60);
      pointer-events:none;
      border-radius: 14px;
    }

    #expB .card-canvas{
      position:relative;
      width:100%;
      margin:16px auto 10px;
      overflow:hidden;
      background:rgba(255,255,255,0.65);
      aspect-ratio: 4 / 5;
      max-height: 52vh;
      touch-action:none;
      border-radius: 14px;
      border: 1px solid rgba(var(--gold-rgb),0.18);
      box-shadow: 0 18px 55px rgba(58,36,48,0.08);
    }
    #expB .photo-frame{
      position:absolute;
      left:7.5%;
      right:7.5%;
      top:10%;
      height:46%;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(var(--gold-rgb),0.22);
      background:rgba(255,255,255,0.78);
      box-shadow:0 10px 22px rgba(58,36,48,0.08);
      display:none;
    }
    #expB .photo-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    #expB .card-canvas[data-mode="hybrid"] .photo-frame{ display:block; }
    #expB .card-canvas[data-mode="decor"] .photo-frame{ display:none !important; }

    #expB .card-canvas::after{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 20% 25%, rgba(255,255,255,0.55), transparent 58%),
        radial-gradient(circle at 70% 40%, rgba(var(--gold-rgb),0.16), transparent 62%),
        radial-gradient(circle at 45% 80%, rgba(232,213,209,0.20), transparent 62%);
      filter: blur(18px);
      opacity: var(--shimmer, 0.10);
      animation: drift 16s ease-in-out infinite;
      pointer-events:none;
    }

    #expB .decor-layer{ position:absolute; inset:0; pointer-events:auto; z-index:3; }
    #expB .sticker{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%) rotate(0deg) scale(1);
      transform-origin: center;
      user-select:none;
      touch-action:none;
      filter:drop-shadow(0 10px 16px rgba(58,36,48,0.12));
      cursor:grab;
      z-index:4;
      will-change: transform, left, top;
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",system-ui,sans-serif;
    }
    #expB .sticker:active{ cursor:grabbing; }

    #expB .decorate-panel{
      margin-top:14px;
      display:grid;
      gap:10px;
      justify-items:center;
    }
    #expB .decorate-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    #expB .pill{
      border:1px solid rgba(var(--gold-rgb),0.42);
      background: linear-gradient(135deg, rgba(255,255,255,0.74), rgba(255,255,255,0.46));
      backdrop-filter:blur(12px);
      border-radius:999px;
      padding:8px 12px;
      font-size:0.7rem;
      letter-spacing:1px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width:92vw;
      color: rgba(var(--green-rgb),0.86);
      box-shadow: 0 18px 55px rgba(58,36,48,0.08);
    }
    #expB .pill input[type="file"]{font-size:0.65rem; max-width:44vw;}
    #expB .pill input[type="range"]{width:140px; max-width:40vw;}
    #expB select{font:inherit;}

    #b-caption{
      margin-top: 10px;
      font-size: 0.66rem;
      letter-spacing: 1.8px;
      text-transform: uppercase;
      opacity: 0.72;
      line-height: 1.35;
      color: rgba(var(--green-rgb),0.72);
    }

    /* =========================
       SEAL STYLES
       ========================= */
    .seal-a{
      display:block;
      margin: 10px auto 14px;
      text-align:center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.62rem;
      letter-spacing: 3.2px;
      text-transform: uppercase;
      color: rgba(var(--rose-rgb),0.82);
      opacity: 0.95;
      padding: 6px 10px;
      width: fit-content;
      border-radius: 10px;
      border: 1px solid rgba(var(--rose-rgb),0.22);
      background: rgba(255,255,255,0.50);
      backdrop-filter: blur(10px);
    }
    .seal-b{
      display:block;
      margin: 10px auto 14px;
      text-align:center;
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 0.62rem;
      letter-spacing: 2.2px;
      text-transform: uppercase;
      color: rgba(var(--gold-rgb),0.72);
      opacity: 0.86;
    }
    #expB .tiny-note{
        font-family:'Lato', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 11.5px;
        line-height: 1.55;
        opacity: 0.72;
        text-align: center;
        letter-spacing: 0.3px;
        margin-top: 10px;
        max-width: 420px;
        margin-left: auto;
        margin-right: auto;
}
  </style>
</head>

<body>
  <!-- BACKGROUND LAYERS -->
  <div id="bgA" class="layer garden-bg"></div>
  <div id="motesA" class="layer"></div>
  <div id="bgB" class="layer garden-bg"></div>
  <div id="petalsB" class="layer"></div>
  <div id="birdsB" class="layer"></div>
  <div class="vignette" id="vignette"></div>

  <div id="app">
    <!-- HOME -->
    <section id="home" class="view active">
      <div class="home-wrap">
        <p class="isa-tag">ISA Chulalongkorn Presents</p>
        <h1 class="main-title">Heart to Heart</h1>
        <p class="sub-theme">one heart reads into the next.</p>

        <div class="home-grid">
          <div class="home-card" id="goA" role="button" tabindex="0" aria-label="Enter On One‚Äôs Heart">
            <p class="home-title">On One‚Äôs Heart</p>
            <p class="home-desc">Spend 3 tokens on traits ‚Üí receive a mirror of your essence and counsel.</p>
          </div>

          <div class="home-card" id="goB" role="button" tabindex="0" aria-label="Enter The Secret Garden">
            <p class="home-title">The Secret Garden</p>
            <p class="home-desc">
              Shuffle with intentions ‚Üí draw a card ‚Üí receive a quote, a book and a movie recommendation,
              decorate your card, and optionally add a photo.
            </p>
          </div>
        </div>

        <p class="note">Tip: Sound begins on first tap/click. One toggle controls both rituals.</p>
      </div>
    </section>

    <!-- EXPERIENCE A -->
    <section id="expA" class="view">
      <div class="topbar">
        <button class="navbtn" id="a-home" type="button">‚Üê Menu</button>
      </div>

      <div class="container">
        <p class="isa-tag">ISA Chulalongkorn Presents</p>
        <h1 class="main-title">Heart to Heart</h1>
        <p class="sub-theme">You‚Äôre not bad at love.</p>
        <p class="opening-line">Love is learned.</p>

        <div class="ritual-bar" aria-label="Ritual progress">
          <div class="steps">
            <div class="step active" id="a-stepToken"><span class="step-dot"></span><span class="step-label">Tokens</span></div>
            <div class="step" id="a-stepRecognize"><span class="step-dot"></span><span class="step-label">Recognition</span></div>
            <div class="step" id="a-stepArticulate"><span class="step-dot"></span><span class="step-label">Articulation</span></div>
            <div class="step" id="a-stepCounsel"><span class="step-dot"></span><span class="step-label">Counsel</span></div>
          </div>
        </div>

        <!-- TOKEN SCREEN -->
        <div id="a-token-screen">
          <p style="margin: 6px 0 6px; font-size: 0.72rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75; color: rgba(58,36,48,0.72);">
            Spend 3 tokens on traits that feel like you
          </p>
          <p class="tiny-note" style="margin-top:6px;">Tap to place. Tap again to return.</p>

          <div class="token-top">
            <div class="token-badge">
              <span>Tokens left</span>
              <span class="token-dots" id="a-tokenDots"></span>
            </div>
            <button class="btn" id="a-tokenClear" type="button">Clear</button>
            <button class="btn btn-save" id="a-beginRecognition" type="button" disabled>Begin Recognition</button>
            <button class="btn btn-sound active" id="a-soundBtnTop" type="button">Sound: On</button>
          </div>

          <div class="trait-grid" id="a-traitGrid"></div>
          <p class="tiny-note" id="a-tokenStatus"></p>
        </div>

        <!-- RECOGNITION SCREEN -->
        <div id="a-recognition-screen" style="display:none;">
          <div class="panel">
            <p style="margin: 0; font-size: 0.62rem; letter-spacing: 3px; text-transform: uppercase; opacity:0.75; color: rgba(58,36,48,0.70);">Recognition</p>
            <div class="recognition-line" id="a-recognitionLine">‚ÄúLove is learned before it is chosen.‚Äù</div>
            <div class="note" id="a-countdownText">Continue unlocks in 3s</div>

            <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
              <button class="btn" id="a-backToTokens" type="button">Back</button>
              <button class="btn btn-save" id="a-continueToSlip" type="button" disabled>Continue</button>
            </div>

            <p class="tiny-note">Take what resonates, leave what doesn‚Äôt.</p>
          </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="a-result-screen">
          <div id="a-capture-frame">
            <span style="font-size:0.55rem; letter-spacing:4px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.88); display:block; margin-bottom:18px;">
              ISA Chulalongkorn
            </span>
            <h2 style="font-family:'Pinyon Script',cursive; font-size:2.8rem; margin:0; line-height:1.02;
             -webkit-background-clip:text; background-clip:text; color:transparent;">
              Heart to Heart
            </h2>
            <div id="a-seal" class="seal-a">Seal: ‚Äî</div>

            <div class="pill-row">
              <span class="pill" id="a-pill-primary">House: ‚Äî</span>
              <span class="pill" id="a-pill-secondary">Secondary: ‚Äî</span>
            </div>

            <div style="font-family:'Playfair Display',serif; font-size: clamp(1.15rem, 4vw, 1.55rem); line-height: 1.35; margin: 18px 0 12px; font-style: italic; color: rgba(58,36,48,0.92);" id="a-frontLine"></div>

            <div style="text-align:left; margin-top: 12px; padding-top: 12px; border-top: 0.8px solid rgba(58,36,48,0.10);">
              <span style="font-size:0.52rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.86); display:block; margin-bottom:6px;">Articulation</span>
              <div style="font-family:'Playfair Display',serif; font-size: 1.05rem; line-height: 1.65; color: rgba(58,36,48,0.88);" id="a-articulationText"></div>
            </div>

            <div style="text-align:left; margin-top: 12px; padding-top: 12px; border-top: 0.8px solid rgba(58,36,48,0.10);">
              <span style="font-size:0.52rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.86); display:block; margin-bottom:6px;">House Analysis</span>
              <div style="font-size: 0.90rem; opacity: 0.92; line-height: 1.6; color: rgba(58,36,48,0.84);" id="a-houseText"></div>
            </div>

            <div style="text-align:left; margin-top: 12px; padding-top: 12px; border-top: 0.8px solid rgba(58,36,48,0.10);">
              <span style="font-size:0.52rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.86); display:block; margin-bottom:6px;">Context</span>
              <div style="font-size: 0.90rem; opacity: 0.92; line-height: 1.6; color: rgba(58,36,48,0.84);" id="a-contextText"></div>
            </div>

            <div style="text-align:left; margin-top: 12px; padding-top: 12px; border-top: 0.8px solid rgba(58,36,48,0.10);">
              <span style="font-size:0.52rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.86); display:block; margin-bottom:6px;">Counsel meant for you</span>
              <div style="margin-top: 8px; padding: 14px 14px; border-radius: 14px; border: 1px solid rgba(var(--gold-rgb),0.22); background: rgba(255,255,255,0.55); position: relative;">
                <div style="font-family:'Playfair Display',serif; font-size: 1.02rem; line-height: 1.55; color: rgba(58,36,48,0.88);" id="a-counselText"></div>
              </div>
            </div>
          </div>

          <div style="margin-top:22px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="a-resetBtn" type="button">Reset</button>
            <button class="btn btn-save" id="a-saveBtn" type="button">Save Picture</button>
            <button class="btn btn-sound active" id="a-soundBtnResult" type="button">Sound: On</button>
            <button class="btn" id="a-goB" type="button">Continue ‚Üí Garden Deck</button>
          </div>
          <p class="tiny-note">If your device blocks downloads (iPhone/iPad), it will open the image in a new tab ‚Üí long-press ‚Üí ‚ÄúSave Image‚Äù.</p>
        </div>
      </div>
    </section>

    <!-- EXPERIENCE B -->
    <section id="expB" class="view">
      <div class="topbar">
        <button class="navbtn" id="b-home" type="button">‚Üê Menu</button>
      </div>

      <div class="container">
        <div id="b-ritual-screen">
          <p class="isa-tag">ISA Chulalongkorn Presents</p>
          <h1 class="main-title">Heart to Heart</h1>
          <p class="sub-theme">The Secret Garden</p>

          <div class="deck-area" id="b-deck-container"></div>
          <p id="b-status-text" style="margin-top: 40px; font-size: 0.7rem; letter-spacing: 3px; text-transform: uppercase; color: rgba(var(--green-rgb),0.70);">
            Tap the deck to begin
          </p>

          <div style="margin-top:18px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-sound active" id="b-soundBtnTop" type="button">Sound: On</button>
          </div>
          <p class="note">(One toggle for both rituals.)</p>
        </div>

        <div id="b-result-screen">
          <div id="b-capture-frame">
            <div id="b-seal" class="seal-b">Under this seal ¬∑ ‚Äî</div>

            <span style="font-size:0.55rem; letter-spacing:4px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.88); display:block; margin-bottom:18px;">
              ISA Chulalongkorn
            </span>

            <h2 style="font-family:'Pinyon Script',cursive; font-size:2.8rem; margin:0; line-height:1.02;
              background: linear-gradient(135deg, rgba(var(--green-rgb),0.92), rgba(var(--gold-rgb),0.88));
              -webkit-background-clip:text; background-clip:text; color:transparent;">
              Heart to Heart
            </h2>

            <div id="b-cardCanvas" class="card-canvas" data-mode="decor">
              <div id="b-photoFrame" class="photo-frame">
                <img id="b-userPhoto" alt="Your photo" />
              </div>
              <div id="b-decorLayer" class="decor-layer"></div>
            </div>

            <div id="b-caption">‚Äî</div>

            <div style="font-family:'Playfair Display',serif; font-size:clamp(1.12rem, 4.1vw, 1.75rem); line-height:1.38; margin:18px 0 14px; font-style:italic; color: rgba(var(--green-rgb),0.88);" id="b-quote-text"></div>
            <div style="font-size:0.72rem; letter-spacing:3px; text-transform:uppercase; opacity:0.62; color: rgba(var(--green-rgb),0.72);" id="b-quote-source"></div>

            <div style="display:flex; justify-content:space-between; gap:14px; margin-top:22px; padding-top:16px; border-top:0.8px solid rgba(58,36,48,0.08); text-align:left;">
              <div>
                <span style="font-size:0.5rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.88); display:block;">Cinematic</span>
                <span style="font-family:'Playfair Display',serif; font-size:0.95rem;" id="b-movie-title"></span>
              </div>
              <div>
                <span style="font-size:0.5rem; letter-spacing:2px; text-transform:uppercase; color: rgba(var(--gold-rgb),0.88); display:block;">Literary</span>
                <span style="font-family:'Playfair Display',serif; font-size:0.95rem;" id="b-book-title"></span>
              </div>
            </div>
          </div>

          <div class="decorate-panel">
            <div class="decorate-row">
              <div class="pill">
                Mode:
                <select id="b-modeSelect">
                  <option value="decor" selected>Mode B ‚Äî Emojis Only</option>
                  <option value="hybrid">Mode A ‚Äî Photo + Emojis</option>
                </select>
              </div>

              <div class="pill" id="b-photoInputWrap" style="display:none;">
                Add Photo:
                <input id="b-photoInput" type="file" accept="image/*" />
              </div>

              <div class="pill">
                Symbol:
                <select id="b-stickerSelect">
                  <option value="‚ô°">‚ô° Simple Heart</option>
                  <option value="‚ô•">‚ô• Classic Heart</option>
                  <option value="‚ù•">‚ù• Fancy Heart</option>
                  <option value="‚ù£">‚ù£ Heart Exclamation</option>
                  <option value="‚ù§">‚ù§ Solid Heart</option>
                  <option value="‡∑Ü">‡∑Ü Curly Heart</option>
                  <option value="‚ô°‚Éù">‚ô°‚Éù Circled Heart</option>
                  <option value="‚ô°Ã∑">‚ô°Ã∑ Striped Heart</option>
                  <option value="‚ô°Ã∂">‚ô°Ã∂ Crossed Heart</option>
                  <option value="‚ô°ÃÜÃà">‚ô°ÃÜÃà Soft Heart</option>
                  <option value=" ö‚ô°…û"> ö‚ô°…û Angel Heart</option>
                  <option value="(‚ô°ÀôÔ∏∂Àô‚ô°)">(‚ô°ÀôÔ∏∂Àô‚ô°) Happy Heart</option>

                  <!-- ü©∑ Emoji Hearts -->
                  <option value="ü©∑">ü©∑ Pink Heart</option>
                  <option value="üíû">üíû Revolving Hearts</option>
                  <option value="‚ù§Ô∏è">‚ù§Ô∏è Red Heart</option>
                  <option value="üß°">üß° Orange Heart</option>
                  <option value="üíõ">üíõ Yellow Heart</option>
                  <option value="üíö">üíö Green Heart</option>
                  <option value="üíô">üíô Blue Heart</option>
                  <option value="ü©µ">ü©µ Light Blue Heart</option>
                  <option value="üíú">üíú Purple Heart</option>
                  <option value="ü§é">ü§é Brown Heart</option>
                  <option value="üñ§">üñ§ Black Heart</option>
                  <option value="ü©∂">ü©∂ Grey Heart</option>
                  <option value="ü§ç">ü§ç White Heart</option>

                  <!-- üíê Flowers & Nature -->
                  <option value="üå∏">üå∏ Blossom</option>
                  <option value="üå∑">üå∑ Tulip</option>
                  <option value="üåº">üåº Daisy</option>
                  <option value="üå∫">üå∫ Hibiscus</option>
                  <option value="üíê">üíê Bouquet</option>
                  <option value="‚úø">‚úø Flower</option>
                  <option value="‚ùÄ">‚ùÄ Blossom Symbol</option>
                  <option value="‚ùÅ">‚ùÅ Floral</option>
                  <option value="‚ùÉ">‚ùÉ Petal</option>
                  <option value="‚ùã">‚ùã Fancy Flower</option>
                  <option value="ìáº">ìáº Botanical</option>
                  <option value="Íï•">Íï• Ornament Flower</option>
                  <option value="Íï§">Íï§ Soft Bloom</option>
                  <option value="Íï¶">Íï¶ Floral Dot</option>
                  <option value="Íïß">Íïß Floral Ring</option>

                  <!-- ‚ú® Sparkles -->
                  <option value="‚úß">‚úß Sparkle</option>
                  <option value="‚ú¶">‚ú¶ Star Spark</option>
                  <option value="‚ú®">‚ú® Sparkles</option>
                  <option value="‚òÜ">‚òÜ Star</option>
                  <option value="‚òÖ">‚òÖ Solid Star</option>
                  <option value="‚≠ë">‚≠ë Magic Star</option>
                  <option value="‚≠í">‚≠í Light Star</option>
                  <option value="‚ãÜÔΩ°Àö‚òæÀöÔΩ°‚ãÜ">‚ãÜÔΩ°Àö‚òæÀöÔΩ°‚ãÜ Moon Glow</option>
                  <option value="‡≠®‡≠ß">‡≠®‡≠ß Ribbon</option>
                  <option value="‡≠≠Ã•‚ãÜ*ÔΩ°">‡≠≠Ã•‚ãÜ*ÔΩ° Soft Spark</option>
                  <option value="Íí∞‡¶å‡ªíÍí±">Íí∞‡¶å‡ªíÍí± Wings</option>
                  <option value="‚∏ù‚∏ù‚∏ù">‚∏ù‚∏ù‚∏ù Tiny Lines</option>
                  <option value="‚îÄ‚îÄ‚îÄ ‚ô° ‚îÄ‚îÄ‚îÄ">‚îÄ‚îÄ‚îÄ ‚ô° ‚îÄ‚îÄ‚îÄ Divider</option>
                  <option value="ÔπèÔπè‚úøÔπèÔπè">ÔπèÔπè‚úøÔπèÔπè Floral Divider</option>
                  <option value="‚Ä¢ ¬∑ Àö ‚úß">‚Ä¢ ¬∑ Àö ‚úß Dots</option>

                  <!--  ï‚Ä¢·¥•‚Ä¢ î Cute Faces -->
                  <option value="(ÔΩ°ÔΩ•œâÔΩ•ÔΩ°)">(ÔΩ°ÔΩ•œâÔΩ•ÔΩ°) Soft Face</option>
                  <option value="(‚âß‚ó°‚â¶)">(‚âß‚ó°‚â¶) Happy Face</option>
                  <option value="(‡πëÀÉ·¥óÀÇ)Ôª≠">(‡πëÀÉ·¥óÀÇ)Ôª≠ Cheer</option>
                  <option value="‡´Æ À∂·µî ·µï ·µîÀ∂ ·Éê">‡´Æ À∂·µî ·µï ·µîÀ∂ ·Éê Bunny</option>
                  <option value=" ï‚Ä¢·¥•‚Ä¢ î"> ï‚Ä¢·¥•‚Ä¢ î Bear</option>
                  <option value="(„Å•ÔΩ°‚óï‚Äø‚Äø‚óïÔΩ°)„Å•">(„Å•ÔΩ°‚óï‚Äø‚Äø‚óïÔΩ°)„Å• Hug</option>

                  <!-- üå∑ Cute Emoji -->
                  <option value="üíå">üíå Love Letter</option>
                  <option value="üçì">üçì Strawberry</option>
                  <option value="üçí">üçí Cherries</option>
                  <option value="üéÄ">üéÄ Ribbon</option>
                  <option value="‚òÅÔ∏è">‚òÅÔ∏è Cloud</option>
                  <option value="ü´ß">ü´ß Bubbles</option>
                  <option value="üß∏">üß∏ Teddy</option>
                  <option value="ü™Ñ">ü™Ñ Magic</option>
                  <option value="ü¶ã">ü¶ã Butterfly</option>
                </select>
              </div>

              <div class="pill">
                Size:
                <input id="b-stickerSize" type="range" min="16" max="96" value="34" />
              </div>
            </div>

            <div class="decorate-row">
              <button class="btn" id="b-placeStickerBtn" type="button">Place Sticker</button>
              <button class="btn" id="b-clearStickersBtn" type="button">Clear</button>
            </div>
         
          <div style="margin-top:18px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="b-resetBtn" type="button">Reset</button>
            <button class="btn btn-save" id="b-saveBtn" type="button">Save Picture</button>
            <button class="btn btn-sound active" id="b-soundBtnResult" type="button">Sound: On</button>
          </div>
          <p class="tiny-note">
  If iOS blocks the download, the image will open instead. Long-press it and choose ‚ÄúSave Image‚Äù.
         </p>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* =========================
       HELPERS
       ========================= */
    const views = ["home","expA","expB"];
    const el = (id)=>document.getElementById(id);

    // iOS Safari often blocks programmatic downloads.
    // This function tries download; if blocked it opens the image in a new tab for manual save.
    async function exportElementAsPNG(node, filename){
      const dpr = Math.min(2.5, Math.max(1.5, window.devicePixelRatio || 2)); // crisp but safe on mobile memory
      const canvas = await html2canvas(node, {
        backgroundColor: null,
        scale: dpr,
        useCORS: true,
        allowTaint: true,
        logging: false,
        scrollX: 0,
        scrollY: -window.scrollY
      });

      const toBlob = (c) => new Promise((resolve) => {
        if (c.toBlob) c.toBlob(resolve, "image/png", 1);
        else resolve(null);
      });

      const blob = await toBlob(canvas);
      if (blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.rel = "noopener";
        document.body.appendChild(a);
        // Some browsers need the click to be directly inside the user gesture; this still works in most cases.
        a.click();
        a.remove();

        // If iOS ignores download, open a tab fallback (user can long-press save).
        // We detect iOS-ish + no "download" support.
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
        const canDownload = "download" in HTMLAnchorElement.prototype;
        if (isIOS || !canDownload) {
          window.open(url, "_blank", "noopener,noreferrer");
        }

        setTimeout(()=>URL.revokeObjectURL(url), 60000);
        return;
      }

      // Worst-case: dataURL
      const dataUrl = canvas.toDataURL("image/png");
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      if (isIOS) window.open(dataUrl, "_blank", "noopener,noreferrer");
      else {
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    }

    /* =========================
       SHARED RITUAL STATE (A -> B)
       ========================= */
    const Ritual = {
      primaryKey: null,
      secondaryKey: null,
      seal: null,
      counsel: null,
      pattern: null,
      slip: null,
      traitTokens: null
    };
    function getShortSeal(){
      if (!Ritual.seal) return "‚Äî";
      return Ritual.seal.replace("ISA-H2H-", "");
    }

    /* =========================
       HOUSE STYLE (A drives B)
       ========================= */
    const HOUSE_STYLE = {
      family:   { crest:"‚ô†", petals:22, birdRate:0.45, shimmer:0.10, mode:"warm" },
      meaning: { crest:"‚ù¶", petals:22, birdRate:0.40, shimmer:0.08, mode:"warm" },
      media:    { crest:"‚ô•", petals:12, birdRate:0.25, shimmer:0.28, mode:"cool" },
      internet: { crest:"‚ô¶", petals:10, birdRate:0.20, shimmer:0.32, mode:"cool" },
      school:   { crest:"‚ô£", petals:14, birdRate:0.30, shimmer:0.14, mode:"clean" }
    };
    function getHouseKeyForB(){ return Ritual.primaryKey || "family"; }
    function getStyleForB(){ return HOUSE_STYLE[getHouseKeyForB()] || HOUSE_STYLE.family; }

    /* =========================
       ROUTER + LAYERS
       ========================= */
    function setThemeFor(view){
      if(view === "expA"){
        el("bgA").classList.add("on");
        el("motesA").classList.add("on");
        el("bgB").classList.remove("on");
        el("petalsB").classList.remove("on");
        el("birdsB").classList.remove("on");
        el("vignette").classList.add("on");

        document.documentElement.style.setProperty("--bg", "#FFF7F2");
        document.documentElement.style.setProperty("--fg", getComputedStyle(document.documentElement).getPropertyValue("--ink"));
        document.body.style.backgroundColor = "#FFF7F2";
        document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue("--ink");
        if(audioPrimed) setPianoMood("A");
      } else if(view === "expB"){
        el("bgA").classList.remove("on");
        el("motesA").classList.remove("on");
        el("bgB").classList.add("on");
        el("petalsB").classList.add("on");
        el("birdsB").classList.add("on");
        el("vignette").classList.add("on");

        applyHouseMoodToGarden();
        document.documentElement.style.setProperty("--bg", "#FFFEFA");
        document.documentElement.style.setProperty("--fg", getComputedStyle(document.documentElement).getPropertyValue("--deep-green"));
        document.body.style.backgroundColor = "#FFFEFA";
        document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue("--deep-green");
        if(audioPrimed) setPianoMood("B");
      } else {
        el("bgA").classList.remove("on");
        el("motesA").classList.remove("on");
        el("bgB").classList.remove("on");
        el("petalsB").classList.remove("on");
        el("birdsB").classList.remove("on");
        el("vignette").classList.remove("on");

        document.documentElement.style.setProperty("--bg", "#FFFBF4");
        document.documentElement.style.setProperty("--fg", getComputedStyle(document.documentElement).getPropertyValue("--ink"));
        document.body.style.backgroundColor = "#FFFBF4";
        document.body.style.color = getComputedStyle(document.documentElement).getPropertyValue("--ink");
        if(audioPrimed) setPianoMood("A");
      }
      // "instant" is not a valid scroll behavior; use auto.
      el("app").scrollTo({ top: 0, behavior: "auto" });
    }

    function showView(id){
      views.forEach(v=>{
        const sec = el(v);
        if(!sec) return;
        sec.classList.toggle("active", v === id);
      });
      setThemeFor(id);
    }

    function bindCardNav(cardId, go){
      const node = el(cardId);
      node.addEventListener("click", go);
      node.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){ e.preventDefault(); go(); }
      });
    }
    bindCardNav("goA", ()=> showView("expA"));
    bindCardNav("goB", ()=> showView("expB"));
    el("a-home").addEventListener("click", ()=> showView("home"));
    el("b-home").addEventListener("click", ()=> showView("home"));
    el("a-goB").addEventListener("click", ()=> showView("expB"));

    /* =========================
       HEART FLOATERS (A)
       ========================= */
    const motesHostA = el("motesA");
    function heartSVG_A({ glow=0.22 } = {}) {
      return `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="hgrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(212,175,55,0.98)"/>
              <stop offset="0.35" stop-color="rgba(178,30,53,0.88)"/>
              <stop offset="1" stop-color="rgba(123,30,43,0.88)"/>
            </linearGradient>
            <filter id="softGlow" x="-40%" y="-40%" width="180%" height="180%">
              <feGaussianBlur stdDeviation="2.6" result="b"/>
              <feColorMatrix in="b" type="matrix"
                values="1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 ${glow} 0" result="g"/>
              <feMerge>
                <feMergeNode in="g"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <path filter="url(#softGlow)"
            d="M32 54s-18.7-10.9-25.2-22.5C1.6 20.7 7.8 10 18.9 10c5.2 0 9.6 2.6 13.1 7
               3.5-4.4 7.9-7 13.1-7C56.2 10 62.4 20.7 57.2 31.5 50.7 43.1 32 54 32 54z"
            fill="url(#hgrad)" />
        </svg>
      `;
    }
    function spawnHeartsA(count = 20){
      motesHostA.innerHTML = "";
      for(let i=0;i<count;i++){
        const wrap = document.createElement("div");
        wrap.className = "heart-mote";
        const x = Math.random() * 100;
        const x2 = Math.max(0, Math.min(100, x + (Math.random()*22 - 11)));
        const dur = 10 + Math.random() * 16;
        const delay = Math.random() * 10;
        const s = (0.45 + Math.random() * 1.35).toFixed(2);
        const r = (-18 + Math.random()*36).toFixed(1) + "deg";
        wrap.style.setProperty("--x", x + "vw");
        wrap.style.setProperty("--x2", x2 + "vw");
        wrap.style.setProperty("--s", s);
        wrap.style.setProperty("--r", r);
        wrap.style.animationDuration = dur + "s";
        wrap.style.animationDelay = delay + "s";
        const size = 16 + Math.random()*26;
        wrap.style.width = size + "px";
        wrap.style.height = size + "px";
        wrap.innerHTML = heartSVG_A({ glow: 0.22 });

        const svg = wrap.querySelector("svg");
        const uid = "h" + Math.random().toString(16).slice(2);
        svg.innerHTML = svg.innerHTML
          .replaceAll("hgrad", uid + "g")
          .replaceAll("softGlow", uid + "f");

        motesHostA.appendChild(wrap);
      }
    }
    spawnHeartsA(20);
    window.addEventListener("resize", ()=> spawnHeartsA(window.innerWidth < 480 ? 14 : 20));

    /* =========================
       PETALS + BIRDS (B)
       ========================= */
    const petalsHostB = el("petalsB");
    function spawnPetalsB(count = 18) {
      petalsHostB.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'petal';
        const left = Math.random() * 100;
        const dur = 10 + Math.random() * 12;
        const delay = Math.random() * 8;
        const size = 8 + Math.random() * 10;
        p.style.left = left + 'vw';
        p.style.animationDuration = dur + 's';
        p.style.animationDelay = delay + 's';
        p.style.width = size + "px";
        p.style.height = (size * 1.5) + "px";
        p.style.opacity = (0.45 + Math.random() * 0.45).toFixed(2);
        petalsHostB.appendChild(p);
      }
    }

    const birdsHostB = el("birdsB");
    function spawnBirdB() {
      const bird = document.createElement('div');
      bird.className = 'bird';
      const mode = Math.random() > 0.5 ? "up" : "down";
      const fromX = "-25vw";
      const toX   = "120vw";
      const fromY = mode === "up" ? (65 + Math.random() * 25) + "vh" : (10 + Math.random() * 25) + "vh";
      const toY   = mode === "up" ? (8 + Math.random() * 25)  + "vh" : (55 + Math.random() * 30) + "vh";
      const dur = 9 + Math.random() * 10;
      const delay = Math.random() * 2.5;
      const scale = (0.75 + Math.random() * 0.7).toFixed(2);
      const opacity = (0.30 + Math.random() * 0.38).toFixed(2);

      bird.style.setProperty('--fromX', fromX);
      bird.style.setProperty('--toX', toX);
      bird.style.setProperty('--fromY', fromY);
      bird.style.setProperty('--toY', toY);
      bird.style.setProperty('--s', scale);
      bird.style.animationDuration = dur + "s";
      bird.style.animationDelay = delay + "s";
      bird.style.opacity = opacity;

      bird.innerHTML = `
        <svg viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" stroke-linecap="round" stroke="rgba(26,42,29,0.62)">
            <path d="M58 36 Q60 34 62 36" stroke-width="3"/>
            <path class="wing left"  d="M60 36 Q40 18 18 26" stroke-width="3.2"/>
            <path class="wing right" d="M60 36 Q80 18 102 26" stroke-width="3.2"/>
          </g>
          <g fill="none" stroke-linecap="round" stroke="rgba(212,175,55,0.22)">
            <path class="wing left"  d="M60 36 Q43 22 22 28" stroke-width="2.1"/>
            <path class="wing right" d="M60 36 Q77 22 98 28" stroke-width="2.1"/>
          </g>
        </svg>
      `;
      birdsHostB.appendChild(bird);
      setTimeout(() => bird.remove(), (dur + delay + 1) * 1000);
    }

    let birdInterval = null;
    function setBirdSpawnRate(rate){
      if (birdInterval) clearInterval(birdInterval);
      birdInterval = setInterval(() => {
        if (Math.random() < rate) spawnBirdB();
      }, 2200);
    }

    function applyHouseMoodToGarden(){
      const style = getStyleForB();
      spawnPetalsB(style.petals);
      setBirdSpawnRate(style.birdRate);
      el("b-cardCanvas").style.setProperty("--shimmer", String(style.shimmer));
      if (style.mode === "cool") document.body.style.backgroundColor = "#FFF9F2";
      else if (style.mode === "clean") document.body.style.backgroundColor = "#FFFEFA";
      else document.body.style.backgroundColor = "#FFF7EB";
    }

    spawnPetalsB(18);
    setBirdSpawnRate(0.30);
    window.addEventListener('resize', () => {
      const style = getStyleForB();
      spawnPetalsB(window.innerWidth < 480 ? Math.max(10, style.petals - 6) : style.petals);
    });

    /* =========================
       ONE AUDIO ENGINE (PIANO ONLY)
       ========================= */
    let audioCtx = null;
    let masterGain = null;
    let pianoGain = null;

    let soundOn = true;
    let audioPrimed = false;

    let pianoLoopTimer = null;
    let pianoIsRunning = false;

    let sceneMood = "A"; // "A" or "B"

    function ensureAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      pianoGain  = audioCtx.createGain();

      masterGain.gain.value = 0.0001;
      pianoGain.gain.value  = 0.0001;

      pianoGain.connect(masterGain);
      masterGain.connect(audioCtx.destination);
    }

    async function primeAndApplyAudio() {
      ensureAudio();
      if (audioCtx.state === "suspended") {
        try { await audioCtx.resume(); } catch (e) {}
      }
      audioPrimed = true;

      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(soundOn ? 0.65 : 0.0001, now + 0.12);

      const currentView = views.find(v => el(v)?.classList.contains("active")) || "home";
      setPianoMood(currentView === "expB" ? "B" : "A");

      updateAllSoundButtons();
      if (soundOn) startPianoAmbience();
    }

    function setSound(on) {
      soundOn = on;
      if (!audioPrimed || !audioCtx || !masterGain) { updateAllSoundButtons(); return; }

      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.exponentialRampToValueAtTime(on ? 0.65 : 0.0001, now + 0.12);

      updateAllSoundButtons();
      if (on) startPianoAmbience();
      else stopPianoAmbience();
    }
    function toggleSound(){ setSound(!soundOn); }

    function updateAllSoundButtons(){
      const label = soundOn ? "Sound: On" : "Sound: Off";
      const ids = ["a-soundBtnTop","a-soundBtnResult","b-soundBtnTop","b-soundBtnResult"];
      ids.forEach(id=>{
        const b = el(id);
        if(!b) return;
        b.textContent = label;
        b.classList.toggle("active", soundOn);
      });
    }

    function setPianoMood(mood){
      sceneMood = (mood === "B") ? "B" : "A";
      if (!audioPrimed || !audioCtx || !pianoGain) return;
      const now = audioCtx.currentTime;
      pianoGain.gain.cancelScheduledValues(now);
      pianoGain.gain.setValueAtTime(pianoGain.gain.value, now);
      const target = soundOn ? (sceneMood === "B" ? 0.62 : 0.55) : 0.0001;
      pianoGain.gain.exponentialRampToValueAtTime(Math.max(0.0001, target), now + 0.35);
    }

    // Prime sound on first user gesture (iOS/Android safe)
    (function bindAutoStart() {
      const once = async () => {
        await primeAndApplyAudio();
        window.removeEventListener("pointerdown", once);
        window.removeEventListener("keydown", once);
      };
      window.addEventListener("pointerdown", once, { passive:true });
      window.addEventListener("keydown", once);
    })();

    ["a-soundBtnTop","a-soundBtnResult","b-soundBtnTop","b-soundBtnResult"].forEach(id=>{
      const btn = el(id);
      btn?.addEventListener("click", (e)=>{ e.stopPropagation(); toggleSound(); });
    });

    function playTone(freq, { when=0, dur=1.2, vel=0.6, pan=0 } = {}) {
      if (!audioCtx || !audioPrimed || !soundOn) return;
      const t0 = audioCtx.currentTime + when;

      const osc = audioCtx.createOscillator();
      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, t0);

      const click = audioCtx.createOscillator();
      click.type = "sine";
      click.frequency.setValueAtTime(freq * 2.0, t0);

      const g = audioCtx.createGain();
      const peak = 0.08 * vel;
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(peak, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(peak * 0.35, t0 + 0.18);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

      const filter = audioCtx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.setValueAtTime(1800 + vel * 1200, t0);
      filter.Q.setValueAtTime(0.8, t0);

      const delay = audioCtx.createDelay();
      delay.delayTime.setValueAtTime(0.14, t0);

      const fb = audioCtx.createGain();
      fb.gain.setValueAtTime(0.22, t0);

      const wet = audioCtx.createGain();
      wet.gain.setValueAtTime(0.35, t0);

      const dry = audioCtx.createGain();
      dry.gain.setValueAtTime(0.9, t0);

      const panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;
      if (panner) panner.pan.setValueAtTime(Math.max(-1, Math.min(1, pan)), t0);

      osc.connect(filter);
      click.connect(filter);

      filter.connect(dry);  dry.connect(g);
      filter.connect(delay); delay.connect(fb); fb.connect(delay); delay.connect(wet); wet.connect(g);

      if (panner) { g.connect(panner); panner.connect(pianoGain); }
      else { g.connect(pianoGain); }

      osc.start(t0); click.start(t0);
      osc.stop(t0 + dur + 0.05);
      click.stop(t0 + 0.03);
    }

    const CHORDS_A = [
      [293.66, 369.99, 440.00],
      [392.00, 493.88, 587.33],
      [246.94, 293.66, 369.99],
      [220.00, 293.66, 329.63],
    ];
    const CHORDS_B = [
      [329.63, 415.30, 493.88],
      [369.99, 466.16, 554.37],
      [293.66, 369.99, 440.00],
      [261.63, 329.63, 392.00],
    ];

    function startPianoAmbience() {
      if (pianoIsRunning) return;
      pianoIsRunning = true;
      let step = 0;

      const tick = () => {
        if (!soundOn || !audioPrimed || !audioCtx) return;

        const chords = (sceneMood === "B") ? CHORDS_B : CHORDS_A;
        const chord = chords[step % chords.length];

        const basePan = -0.25 + Math.random() * 0.5;
        const vel = 0.45 + Math.random() * 0.25;

        playTone(chord[0] / 2, { when: 0.00, dur: 2.2, vel: vel * 0.65, pan: basePan * 0.6 });
        playTone(chord[0],     { when: 0.05, dur: 1.8, vel: vel,        pan: basePan });
        playTone(chord[1],     { when: 0.32, dur: 1.6, vel: vel * 0.90, pan: basePan * 0.8 });
        playTone(chord[2],     { when: 0.62, dur: 1.4, vel: vel * 0.85, pan: basePan * 0.6 });

        step++;
        pianoLoopTimer = setTimeout(tick, 2400);
      };

      tick();
    }

    function stopPianoAmbience() {
      pianoIsRunning = false;
      if (pianoLoopTimer) { clearTimeout(pianoLoopTimer); pianoLoopTimer = null; }
    }

    function softChime(type = "place") {
      const map = { place:[659.25,880.0], gate:[523.25,659.25], reveal:[392.0,523.25] };
      const seq = map[type] || map.place;
      playTone(seq[0], { when: 0.00, dur: 0.55, vel: 0.35, pan: -0.05 });
      playTone(seq[1], { when: 0.08, dur: 0.60, vel: 0.30, pan:  0.08 });
    }

    /* =========================
   EXPERIENCE A LOGIC (tokens)
   Psychology-rooted, gentle, universal
   ========================= */

const teachers = {
  family: { 
    label: "House of Kin",
    analysis: "This House learns love through closeness, duty, and belonging. Care is expressed through responsibility, often before it is expressed through words. Love feels safest when everyone is ok.",
    slips: [
      { // 0: The Shield
        pattern: "You keep peace by shrinking yourself.",
        articulation: "You learned early that harmony mattered. Having a need felt the same as being a burden. So you quiet your wants, soften your opinions, and make yourself smaller than you actually are.",
        context: "This is not selflessness, it is disappearance. You hide parts of yourself because you fear that taking up space will cost you love. Over time, this creates closeness without recognition.",
      },
      { // 1: The Armor
        pattern: "You earn closeness by being useful.",
        articulation: "You step in, anticipate needs, and hold everything together. You believe that if you stop doing, caring, or fixing, the connection will loosen or disappear.",
        context: "Being needed has replaced being wanted. Responsibility becomes a strategy to secure love rather than a shared exchange.",
        counsel: "Let someone else carry a small piece of the weight. Stay connected without managing the outcome."
      },
      { // 2: The Pulse
        pattern: "You track everyone else‚Äôs feelings before your own.",
        articulation: "You sense shifts in mood instantly, masterfully attuned to the slight shift in a door closing or the tone of a 'hello'. You cannot rest until everyone around you is 'okay'.",
        context: "This sensitivity once protected you. But it pull attention away from your own disconnect you from your own emotional signals, leaving your needs unheard even by yourself.", 
        counsel: "Before adjusting to anyone else, pause. Ask: 'What am I feeling right now?' Check your internal weather first before you check theirs."
      }
    ]
  },

  media: { 
    label: "House of Theatre",
    analysis: "This House learns love through stories, intensity, and emotional highs. It values the high-notes of connection but fears the silence of the valley.",
    slips: [
      { // 0: The Shield
        {
        pattern: "You create intensity to avoid vulnerability.",
        articulation: "When closeness feels uncertain, you stir emotion. Conflict, drama, or passion feels safer than asking plainly for reassurance or care.",
        context: "Intensity protects you from the risk of quiet rejection. If the energy is high, at least you know something is happening.",
        counsel: "Do not create a storm. Ask directly for what you want without adding fire."
      },
      { // 1: The Armor
        pattern: "You are performing a version of love you saw in a story.",
        articulation: "You worry about how your love looks. Is it grand enough? Is it meaningful? You are so busy directing the movie of your life that you‚Äôve stopped living in it.",
        context: "You have a fear that your real, unedited self is too boring or too messy to hold anyone's interest for long.",
        counsel: "Drop the storyline. Ask yourself: 'How does this actually feel in my body right now?'"
      },
      { // 2: The Pulse
        pattern: "You feel unsettled when things are emotionally quiet.",
        articulation: "When feelings slow down, you begin scanning. You wonder if something is wrong, if interest is fading, if the connection is slipping away.",
        context: "Calm is unfamiliar, not unsafe. Emotional stillness is where trust actually grows.",
        counsel: "Stay present in the quiet. Notice whether calm brings steadiness rather than loss."
      }
    ]
  },

  meaning: { 
    label: "House of Meaning",
    analysis: "This House learns love as something sacred, purposeful, and significant. Love is tied to values, vows, and ideals.",
    slips: [
      { // 0: The Shield
        pattern: "You turn goodness into a defense against being fully seen.",
        articulation: "You strive to be patient, kind, and morally right. You are loved for your virtue, not your rawness.",
        context: "Messy emotions are disciplined instead of expressed. Desire, anger, and selfishness are treated as failures rather than human signals.",
        counsel: "Share one thought that feels unkind, selfish, or imperfect. Love that requires perfection is just an assignment."
      },
      { // 1: The Armor 
        pattern: "You love an idea longer than you love a living person.",
        articulation: "You remain loyal to vows, memories, or ideals even when the relationship has changed. You protect what it was supposed to be.",
        context: "Change feels like betrayal when love is sacred. Growth is mistaken for decline, and preserving the ideal becomes safer than meeting the person as they are now.",
        counsel: "Ask: 'What does this relationship need today?' Love must evolve to remain alive."
      },
      { // 2: The Pulse 
        pattern: "You love under observation.",
        articulation: "Whether the gaze is divine, familial, cultural, or internalized, you love as though you are being watched and evaluated.",
        context: "When love is governed by judgment, desire becomes risky. Being right feels safer than being close.",
        counsel: "Ask yourself: 'What would I choose if no one were watching?' Practice one small act of connection that feels honest, not exemplary."
    }
  ]
},

  school: { 
    label: "House of Measure",
    analysis: "This House learns love through evaluation, progress, and achievement.",
    slips: [
      { // 0: The Shield
        pattern: "You analyze to avoid uncertainty.",
        articulation: "You analyze love like a problem to be solved. If you can just understand the 'why' and the 'how,' you think you can control the outcome and avoid the pain.",
        context: "Achievement systems reward certainty. Love, however, grows through openness to the unknown.",
        counsel: "Replace one analysis with one honest question. Let clarity come from contact, not calculation."
      },
      { // 1: The Armor
        pattern: "You try to be impressive to stay chosen.",
        articulation: "You offer competence, maturity, and value. You make yourself useful, accomplished, and hard to replace.",
        context: "Love becomes something to maintain through performance, achievement rather than mutual presence.",
        counsel: "Let yourself be chosen without proving value."
      },
      { // 2: The Pulse
        pattern: "You feel late to something invisible.",
        articulation: "You compare where you are to where you think you should be.",
        context: "Timelines are social constructions. Attachment grows at its own pace.",
        counsel: "Release the clock. Ask instead: 'Does this nourish me?'"
      }
    ]
  },

  internet: { 
    label: "House of Distance",
    analysis: "This House learns love through autonomy, boundaries, and exit options. Self-protection is a form of dignity.",
    slips: [
      { // 0: The Shield
        pattern: "You leave before you can be left.",
        articulation: "Detachment feels safer than hoping.",
        context: "Nervous systems heal through repair, not escape.",
        counsel: "Stay a little longer than your instinct tells you to. Let yourself be seen trying."
      },
      { // 1: The Armor
        pattern: "You communicate indirectly to stay safe.",
        articulation: ""You hint, test, and signal instead of asking or stating clearly.",
        context: "Clarity builds security. Ambiguity keeps you protected, but it also keeps you uncertain.",
        counsel: "Say one thing plainly and directly."
      },
      { // 2: The Pulse
        pattern: "You feel most secure when you need no one.",
        articulation: "You equate closeness with loss of control. Dependence feels risky, so you prioritize self-sufficiency even when connection is available.",
        context: "Safety becomes private rather than shared.",
        counsel: "Practice receiving help. Let support coexist with autonomy."
      }
    ]
  }
};

    const recognitionLines = [
      "‚ÄúLove is learned.‚Äù",
      "‚ÄúYou are not bad at love.‚Äù",
    ];

    const TRAITS = [
      { id:"fast",  title:"I fall too fast.", sub:"speed ‚Ä¢ spark ‚Ä¢ rush", w:{ media:2, internet:1 } },
      { id:"numb",  title:"I don‚Äôt feel enough.", sub:"muted ‚Ä¢ small ‚Ä¢ numb", w:{ internet:2, media:1 } },
      { id:"leave", title:"I leave first.", sub:"exit ‚Ä¢ control ‚Ä¢ safety", w:{ internet:2, family:1 } },
      { id:"guilt", title:"I feel guilty wanting more.", sub:"need ‚Ä¢ guilt ‚Ä¢ harmony", w:{ family:2, meaning:1 } },
      { id:"peace", title:"I prioritize peace over truth.", sub:"quiet ‚Ä¢ restraint ‚Ä¢ harmony", w:{ family:2, school:1 } },
      { id:"think", title:"I overthink signals.", sub:"analysis ‚Ä¢ certainty ‚Ä¢ fear", w:{ school:2, media:1 } },
      { id:"prove", title:"I perform to be chosen.", sub:"earn ‚Ä¢ impress ‚Ä¢ belong", w:{ school:2, family:1 } },
      { id:"duty",  title:"I take love seriously.", sub:"meaning ‚Ä¢ devotion ‚Ä¢ care", w:{ meaning:2, family:1 } }
    ];

    const aTokenScreen = el("a-token-screen");
    const aRecognitionScreen = el("a-recognition-screen");
    const aTraitGrid = el("a-traitGrid");
    const aTokenDots = el("a-tokenDots");
    const aTokenStatus = el("a-tokenStatus");
    const aTokenClearBtn = el("a-tokenClear");
    const aBeginRecognitionBtn = el("a-beginRecognition");
    const aBackToTokensBtn = el("a-backToTokens");
    const aContinueToSlipBtn = el("a-continueToSlip");
    const aRecognitionLineEl = el("a-recognitionLine");
    const aCountdownTextEl = el("a-countdownText");
    const aStepToken = el("a-stepToken");
    const aStepRecognize = el("a-stepRecognize");
    const aStepArticulate = el("a-stepArticulate");
    const aStepCounsel = el("a-stepCounsel");

    let tokensTotal = 3;
    let tokensLeft = 3;
    let traitTokens = Object.fromEntries(TRAITS.map(t => [t.id, 0]));
    let scores = { family:0, media:0, meaning:0, school:0, internet:0 };
    let primaryKey = null;
    let secondaryKey = null;
    let recognitionTimer = null;

    function setStepA(active){
      [aStepToken, aStepRecognize, aStepArticulate, aStepCounsel].forEach(s=>s.classList.remove("active"));
      if(active === "token") aStepToken.classList.add("active");
      if(active === "recognition") aStepRecognize.classList.add("active");
      if(active === "articulation") aStepArticulate.classList.add("active");
      if(active === "counsel") aStepCounsel.classList.add("active");
    }

    function renderTokenDotsA(){
      aTokenDots.innerHTML = "";
      for(let i=0;i<tokensTotal;i++){
        const d = document.createElement("span");
        d.className = "dot" + (i < tokensLeft ? " filled" : "");
        aTokenDots.appendChild(d);
      }
    }

    function recomputeScoresA(){
      scores = { family:0, media:0, meaning:0, school:0, internet:0 };
      for(const tr of TRAITS){
        const c = traitTokens[tr.id] || 0;
        if(c <= 0) continue;
        for(const k of Object.keys(tr.w)){
          scores[k] += c * tr.w[k];
        }
      }
      const order = ["family","media","meaning","school","internet"];
      const arr = order.map(k => ({k, n: scores[k]}))
        .sort((a,b)=> b.n - a.n || order.indexOf(a.k) - order.indexOf(b.k));
      primaryKey = arr[0].n > 0 ? arr[0].k : null;
      secondaryKey = arr[1].n > 0 ? arr[1].k : null;
      aBeginRecognitionBtn.disabled = (tokensLeft !== 0);
    }

    function deterministicSlipIndexA(forTeacherKey){
      const w = { fast:3, numb:5, leave:7, guilt:11, peace:13, think:17, prove:19, duty:23 };
      let h = 0;
      for(const tr of TRAITS){
        h += (traitTokens[tr.id] || 0) * w[tr.id];
      }
      return h % teachers[forTeacherKey].slips.length;
    }

    function computeSealA(){
      const w = { fast:31, numb:37, leave:41, guilt:43, peace:47, think:53, prove:59, duty:61 };
      let n = 0;
      for(const tr of TRAITS){
        n += (traitTokens[tr.id] || 0) * w[tr.id];
      }
      const seal = (n + 2026).toString(36).toUpperCase();
      return "ISA-H2H-" + seal.padStart(4,"0");
    }

    function renderTraitsA(){
      aTraitGrid.innerHTML = "";
      recomputeScoresA();

      TRAITS.forEach(tr=>{
        const count = traitTokens[tr.id] || 0;
        const tile = document.createElement("div");
        tile.className = "trait";
        tile.tabIndex = 0;

        const slots = Array.from({length:3}).map((_,i)=>
          `<span class="slot ${i < count ? "on":""}"></span>`
        ).join("");

        tile.innerHTML = `
          <div class="trait-title">${tr.title}</div>
          <div class="trait-sub">${tr.sub}</div>
          <div class="trait-meter">
            <div class="trait-meter-label">Placed</div>
            <div class="token-slots" aria-label="Tokens placed">${slots}</div>
          </div>
        `;

        const addOrRemoveToken = (mode = "auto")=>{
          const current = traitTokens[tr.id] || 0;
          const wantRemove = (mode === "remove") || (mode === "auto" && current > 0);

          if (wantRemove) {
            if (current <= 0) return;
            traitTokens[tr.id] -= 1;
            tokensLeft += 1;
            renderTokenDotsA();
            renderTraitsA();
            softChime("gate");
            aTokenStatus.textContent = `Token returned. ${tokensLeft} left.`;
            return;
          }

          if(tokensLeft <= 0){
            aTokenStatus.textContent = "No tokens left. Return one token to move it.";
            return;
          }
          if(current >= 3) return;

          traitTokens[tr.id] += 1;
          tokensLeft -= 1;
          renderTokenDotsA();
          renderTraitsA();
          softChime("place");

          aTokenStatus.textContent = (tokensLeft > 0)
            ? `Token placed. ${tokensLeft} left.`
            : `Allocation complete. Proceed to recognition.`;
        };

        tile.addEventListener("click", (e)=>{
          if (e.shiftKey) addOrRemoveToken("remove");
          else addOrRemoveToken("auto");
        });
        tile.addEventListener("contextmenu", (e)=>{
          e.preventDefault();
          addOrRemoveToken("remove");
        });
        tile.addEventListener("keydown", (e)=>{
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            addOrRemoveToken(e.shiftKey ? "remove" : "auto");
          }
        });

        // long press remove (mobile)
        let pressTimer = null;
        tile.addEventListener("touchstart", ()=>{
          pressTimer = setTimeout(()=> addOrRemoveToken("remove"), 420);
        }, { passive:true });
        tile.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; }, { passive:true });
        tile.addEventListener("touchmove", ()=>{ if(pressTimer) clearTimeout(pressTimer); pressTimer=null; }, { passive:true });

        aTraitGrid.appendChild(tile);
      });

      aTokenStatus.textContent = (tokensLeft > 0)
        ? "Spend all 3 tokens to continue."
        : "Allocation complete. Proceed to recognition.";
    }

    function clearTraitsA(){
      traitTokens = Object.fromEntries(TRAITS.map(t => [t.id, 0]));
      tokensLeft = tokensTotal;
      primaryKey = null;
      secondaryKey = null;

      aTokenStatus.textContent = "Cleared.";
      renderTokenDotsA();
      renderTraitsA();

      aBeginRecognitionBtn.disabled = true;
      setStepA("token");
      softChime("gate");

      el("a-result-screen").style.display = "none";
      el("a-result-screen").style.opacity = "0";
      aRecognitionScreen.style.display = "none";
      aTokenScreen.style.display = "block";
    }
    aTokenClearBtn.addEventListener("click", clearTraitsA);

    function startRecognitionA(){
      if(tokensLeft !== 0){
        aTokenStatus.textContent = "Please spend all tokens first.";
        return;
      }
      recomputeScoresA();
      if(!primaryKey){
        aTokenStatus.textContent = "Please select at least one trait.";
        return;
      }

      setStepA("recognition");
      aTokenScreen.style.display = "none";
      aRecognitionScreen.style.display = "block";

      const idx = deterministicSlipIndexA(primaryKey) % recognitionLines.length;
      aRecognitionLineEl.textContent = recognitionLines[idx];
      softChime("gate");

      aContinueToSlipBtn.disabled = true;
      aCountdownTextEl.textContent = "Continue unlocks in 3s";

      const start = performance.now();
      const duration = 3000;

      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);
      const tick = (now)=>{
        const elapsed = now - start;
        const remaining = Math.max(0, (duration - elapsed) / 1000);
        if(remaining > 0.01){
          aCountdownTextEl.textContent = `Continue unlocks in ${Math.ceil(remaining)}s`;
          recognitionTimer = requestAnimationFrame(tick);
        } else {
          aCountdownTextEl.textContent = "Ready.";
          aContinueToSlipBtn.disabled = false;
        }
      };
      recognitionTimer = requestAnimationFrame(tick);
    }
    aBeginRecognitionBtn.addEventListener("click", startRecognitionA);

    aBackToTokensBtn.addEventListener("click", ()=>{
      if(recognitionTimer) cancelAnimationFrame(recognitionTimer);
      aRecognitionScreen.style.display = "none";
      aTokenScreen.style.display = "block";
      setStepA("token");
      softChime("place");
    });

    function showSlipA(){
      recomputeScoresA();
      if(!primaryKey) return;

      const i = deterministicSlipIndexA(primaryKey);
      const slip = teachers[primaryKey].slips[i];

      Ritual.primaryKey = primaryKey;
      Ritual.secondaryKey = secondaryKey;
      Ritual.seal = computeSealA();
      Ritual.counsel = slip.counsel;
      Ritual.pattern = slip.pattern;
      Ritual.slip = slip;
      Ritual.traitTokens = { ...traitTokens };

      setStepA("articulation");
      aRecognitionScreen.style.display = "none";
      aTokenScreen.style.display = "none";

      const result = el("a-result-screen");
      result.style.display = "block";
      requestAnimationFrame(()=> result.style.opacity = "1");

      el("a-pill-primary").textContent = `House: ${teachers[primaryKey].label}`;
      el("a-pill-secondary").textContent = `Secondary: ${secondaryKey ? teachers[secondaryKey].label : "‚Äî"}`;
      el("a-seal").textContent = `Seal: ${Ritual.seal}`;

      el("a-frontLine").textContent = slip.pattern;
      el("a-articulationText").textContent = slip.articulation;

      el("a-houseText").textContent =
        teachers[primaryKey].analysis +
        (secondaryKey ? ` A secondary influence from ${teachers[secondaryKey].label} may color how this shows up.` : "");

      el("a-contextText").textContent = slip.context;
      el("a-counselText").textContent = slip.counsel;

      softChime("reveal");
      setTimeout(()=> setStepA("counsel"), 800);
    }
    aContinueToSlipBtn.addEventListener("click", showSlipA);

    el("a-saveBtn").addEventListener("click", async ()=>{
      await exportElementAsPNG(el("a-capture-frame"), "HeartToHeart_ISA_ReflectionSlip.png");
    });

    el("a-resetBtn").addEventListener("click", clearTraitsA);

    renderTokenDotsA();
    renderTraitsA();
    setStepA("token");

    /* =========================
       EXPERIENCE B DATA
       ========================= */
    const colorPalette = [
      { name:"Ivory Silk", hex:"#fffdf0", quote:"To love at all is to be vulnerable.", source:"C.S. Lewis", movie:"Shadowlands", book:"The Four Loves" },
      { name:"Vintage Champagne", hex:"#f5ead0", quote:"Love is not blind; it sees more, not less.", source:"Erich Fromm", movie:"In the Mood for Love", book:"The Art of Loving" },
      { name:"Tudor Rose", hex:"#fce3e3", quote:"Everything that frightens us is something helpless that wants our love.", source:"Rainer Maria Rilke", movie:"The Shape of Water", book:"Letters to a Young Poet" },
      { name:"English Lavender", hex:"#e8e1f5", quote:"It is not necessary to hurry intimacy.", source:"Anne Carson", movie:"Before Sunset", book:"Eros the Bittersweet" },
      { name:"Versailles Sage", hex:"#e2ede4", quote:"The world is full of magic things, patiently waiting for our senses to grow sharper.", source:"W.B. Yeats", movie:"Song of the Sea", book:"The Wind Among the Reeds" },
      { name:"Gilded Moss", hex:"#ecebbd", quote:"The only way to make sense out of change is to plunge into it.", source:"Alan Watts", movie:"Spring, Summer, Fall, Winter... and Spring", book:"The Wisdom of Insecurity" },
      { name:"Biedermeier Blue", hex:"#e0f0f5", quote:"Loneliness is the poverty of self; solitude is the richness of self.", source:"May Sarton", movie:"Lost in Translation", book:"Journal of a Solitude" },
      { name:"Old Manor Taupe", hex:"#ede6e1", quote:"Acceptance is a small, quiet room.", source:"Cheryl Strayed", movie:"Nomadland", book:"Tiny Beautiful Things" },
      { name:"Terracotta Sundial", hex:"#f5e6d3", quote:"Beauty is in things imperfect, impermanent, and incomplete.", source:"Leonard Koren", movie:"Arrietty", book:"Wabi-Sabi for Artists, Designers, Poets & Philosophers" },
      { name:"Slate Manor", hex:"#e1e6e8", quote:"Love is the extremely difficult realization that something other than oneself is real.", source:"Iris Murdoch", movie:"Eternal Sunshine of the Spotless Mind", book:"The Sovereignty of Good" },
      { name:"Linen Prayer", hex:"#fcfaf7", quote:"Love is not a relationship between one person and another, but a relationship between a person and love itself.", source:"S√∏ren Kierkegaard", movie:"Still Walking", book:"Works of Love" },
      { name:"Orchard Ash", hex:"#f0f0f0", quote:"Love, by its very nature, is unworldly.", source:"Hannah Arendt", movie:"A Hidden Life", book:"The Human Condition" },
      { name:"Cemetery Stone", hex:"#f3f2f1", quote:"To be alone is to be with the world without intermediaries.", source:"Maurice Blanchot", movie:"Taste of Cherry", book:"The Space of Literature" },
      { name:"Pale Concrete", hex:"#f6f5f2", quote:"Nothing is missing. Something is simply not added.", source:"Gilles Deleuze", movie:"Columbus", book:"Negotiations" },
      { name:"Oat Chapel", hex:"#f3eddc", quote:"Love is an act of faith, and whoever is of little faith is also of little love.", source:"Erich Fromm", movie:"Ordet", book:"The Art of Loving" },
      { name:"Ash Rose", hex:"#f2eaea", quote:"Grief is the final manifestation of love.", source:"Joan Didion", movie:"Aftersun", book:"Blue Nights" }
    ];

    const HOUSE_PALETTE = {
      family:   ["Ivory Silk","Vintage Champagne","Old Manor Taupe","Oat Chapel","Linen Prayer","Ash Rose","Versailles Sage","Gilded Moss"],
      meaning: ["Linen Prayer","Oat Chapel","Ivory Silk","Vintage Champagne","Old Manor Taupe","Versailles Sage"],
      media:    ["Tudor Rose","English Lavender","Biedermeier Blue","Slate Manor","Ash Rose"],
      internet: ["Slate Manor","Cemetery Stone","Pale Concrete","Orchard Ash","Biedermeier Blue"],
      school:   ["Slate Manor","Linen Prayer","Old Manor Taupe","Terracotta Sundial","Biedermeier Blue","Vintage Champagne"]
    };

    const TRAIT_BIAS = {
      fast:   ["English Lavender","Tudor Rose"],
      numb:   ["Cemetery Stone","Pale Concrete"],
      leave:  ["Slate Manor","Orchard Ash"],
      guilt:  ["Oat Chapel","Linen Prayer"],
      peace:  ["Old Manor Taupe","Vintage Champagne"],
      think:  ["Slate Manor","Biedermeier Blue"],
      prove:  ["Terracotta Sundial","Vintage Champagne"],
      duty:   ["Linen Prayer","Versailles Sage"],
    };

    function getTopTraitsA(limit = 2){
      if(!Ritual.traitTokens) return [];
      return Object.entries(Ritual.traitTokens)
        .filter(([,c])=>c>0)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,limit)
        .map(([id])=>id);
    }

    function pickFromHousePool(){
      const hk = getHouseKeyForB();
      const houseNames = HOUSE_PALETTE[hk] || HOUSE_PALETTE.family;

      const topTraits = getTopTraitsA(2);
      const traitNames = topTraits.flatMap(tid => TRAIT_BIAS[tid] || []);

      const combined = [...new Set([...traitNames, ...houseNames])];
      const pool = colorPalette.filter(c => combined.includes(c.name));
      const chooseFrom = pool.length ? pool : colorPalette;
      return chooseFrom[Math.floor(Math.random() * chooseFrom.length)];
    }

    /* =========================
       EXPERIENCE B LOGIC (deck + reveal)
       ========================= */
    const deckB = el('b-deck-container');
    const statusB = el('b-status-text');
    let shuffleStateB = 0;

    function createDeckB() {
      deckB.innerHTML = "";
      const crest = getStyleForB().crest;
      for (let i = 0; i < 12; i++) {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.zIndex = i;
        card.innerHTML = `<div class="card-crest">${crest}</div>`;
        card.style.transform = `translate(${i * 0.5}px, ${i * 0.5}px)`;
        card.onclick = () => {
          if (shuffleStateB < 3) runShuffleB();
          else if (shuffleStateB === 4) revealCardB();
        };
        deckB.appendChild(card);
      }
    }

    function runShuffleB() {
      shuffleStateB++;
      const cards = deckB.querySelectorAll('.card');
      cards.forEach((card) => {
        const rx = (Math.random() - 0.5) * 380;
        const ry = (Math.random() - 0.5) * 320;
        const rr = (Math.random() - 0.5) * 90;
        card.style.transform = `translate(${rx}px, ${ry}px) rotate(${rr}deg)`;
      });
      statusB.innerText = `Shuffling Intentions... (${shuffleStateB}/3)`;
      setTimeout(() => {
        cards.forEach((card, i) => card.style.transform = `translate(${i * 0.3}px, ${i * 0.3}px) rotate(0deg)`);
        if (shuffleStateB === 3) setTimeout(fanCardsB, 600);
      }, 800);
    }

    function fanCardsB() {
      const cards = deckB.querySelectorAll('.card');
      shuffleStateB = 4;
      statusB.innerText = "Draw your heart's secret";
      const windowWidth = window.innerWidth;
      let spread, angleStep;
      if (windowWidth < 480) { spread = 22; angleStep = 5; }
      else if (windowWidth < 1024) { spread = 35; angleStep = 7; }
      else { spread = 45; angleStep = 9; }
      cards.forEach((card, i) => {
        const centerOffset = (cards.length - 1) / 2;
        const angle = (i - centerOffset) * angleStep;
        const x = (i - centerOffset) * spread;
        const y = windowWidth < 480 ? 10 : 20;
        card.style.transform = `translate(${x}px, ${y}px) rotate(${angle}deg)`;
      });
    }

    function revealCardB() {
      const data = pickFromHousePool();

      el('b-ritual-screen').style.opacity = '0';
      applyHouseMoodToGarden();

      el("b-caption").textContent = Ritual.counsel ? Ritual.counsel : "Take what resonates. Leave what doesn‚Äôt.";
      el("b-seal").textContent = `Under this seal ¬∑ ${getShortSeal()}`;

      document.body.style.backgroundColor = data.hex;

      if(audioPrimed) setPianoMood("B");

      setTimeout(() => {
        el('b-ritual-screen').style.display = 'none';
        el('b-result-screen').style.display = 'block';
        el('b-quote-text').innerText = data.quote;
        el('b-quote-source').innerText = `‚Äî ${data.source}`;
        el('b-movie-title').innerText = data.movie;
        el('b-book-title').innerText = data.book;
        setTimeout(() => { el('b-result-screen').style.opacity = '1'; }, 60);
      }, 900);
    }

    el("b-saveBtn").addEventListener("click", async ()=>{
      await exportElementAsPNG(el("b-capture-frame"), "HeartToHeart_ISA.png");
    });

    el("b-resetBtn").addEventListener("click", ()=>{
      shuffleStateB = 0;
      el("b-result-screen").style.display = "none";
      el("b-result-screen").style.opacity = "0";
      el("b-ritual-screen").style.display = "block";
      el("b-ritual-screen").style.opacity = "1";
      document.body.style.backgroundColor = "#FFFEFA";
      statusB.innerText = "Tap the deck to begin";
      createDeckB();
      stickersB.length = 0;
      decorLayerB.innerHTML = "";
      applyHouseMoodToGarden();
      if(audioPrimed) setPianoMood("A");
    });

    createDeckB();

    /* =========================
       B Mode + Photo + Stickers
       ========================= */
    const cardCanvasB = el("b-cardCanvas");
    const decorLayerB = el("b-decorLayer");
    const userPhotoB = el("b-userPhoto");
    const modeSelectB = el("b-modeSelect");
    const photoInputB = el("b-photoInput");
    const photoInputWrapB = el("b-photoInputWrap");
    const stickerSelectB = el("b-stickerSelect");
    const stickerSizeB = el("b-stickerSize");
    const placeStickerBtnB = el("b-placeStickerBtn");
    const clearStickersBtnB = el("b-clearStickersBtn");

    const stickersB = [];
    let activeStickerIdB = null;

    function setActiveStickerB(id) {
      activeStickerIdB = id;
      decorLayerB.querySelectorAll(".sticker").forEach(elm => {
        elm.style.outline = (elm.dataset.id === id) ? "1px dashed rgba(212,175,55,0.55)" : "none";
        elm.style.outlineOffset = "6px";
      });
    }

    function setModeB(mode) {
      const isHybrid = mode === "hybrid";
      cardCanvasB.dataset.mode = mode;
      photoInputWrapB.style.display = isHybrid ? "inline-flex" : "none";
      if (!isHybrid) {
        userPhotoB.removeAttribute("src");
        userPhotoB.style.display = "none";
        photoInputB.value = "";
      } else {
        userPhotoB.style.display = userPhotoB.src ? "block" : "none";
      }
    }
    modeSelectB.addEventListener("change", (e) => setModeB(e.target.value));
    setModeB(modeSelectB.value);

    photoInputB.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      userPhotoB.src = URL.createObjectURL(file);
      userPhotoB.style.display = "block";
    });

    function clampToCanvasB(x, y, elNode) {
      const host = decorLayerB.getBoundingClientRect();
      const rect = elNode.getBoundingClientRect();
      const halfW = rect.width / 2;
      const halfH = rect.height / 2;
      return {
        x: Math.max(halfW, Math.min(host.width - halfW, x)),
        y: Math.max(halfH, Math.min(host.height - halfH, y)),
      };
    }

    function removeStickerB(id) {
      const idx = stickersB.findIndex((s) => s.id === id);
      if (idx !== -1) stickersB.splice(idx, 1);
      const elNode = decorLayerB.querySelector(`[data-id="${id}"]`);
      if (elNode) elNode.remove();
    }

    function applyTransformB(elNode, s) {
      elNode.style.transform = `translate(-50%,-50%) rotate(${s.rot}deg) scale(${s.scale})`;
    }

    function makeTransformableB(elNode, s) {
      let dragging = false;
      let rotateMode = false;
      let scaleMode = false;
      let startAngle = 0;
      let startRot = 0;
      let startY = 0;
      let startScale = 1;
      let gestureActive = false;
      let startDist = 0;
      let startGestureAngle = 0;

      const getCenter = () => {
        const r = elNode.getBoundingClientRect();
        return { cx: r.left + r.width / 2, cy: r.top + r.height / 2 };
      };
      const angleBetween = (p1, p2) =>
        Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI);
      const distBetween = (p1, p2) => Math.hypot(p2.x - p1.x, p2.y - p1.y);
      const clampScale = (v) => Math.max(0.35, Math.min(3.2, v));

      function onDown(e) {
        e.preventDefault();
        e.stopPropagation();
        elNode.setPointerCapture?.(e.pointerId);
        setActiveStickerB(s.id);
        dragging = true;
        rotateMode = e.altKey === true;
        scaleMode = e.shiftKey === true;

        if (rotateMode) {
          const { cx, cy } = getCenter();
          startAngle = angleBetween({ x: cx, y: cy }, { x: e.clientX, y: e.clientY });
          startRot = s.rot;
        }
        if (scaleMode) {
          startY = e.clientY;
          startScale = s.scale;
        }
        elNode.style.cursor = "grabbing";
      }

      function onMove(e) {
        if (!dragging) return;
        const host = decorLayerB.getBoundingClientRect();

        if (scaleMode) {
          const dy = (startY - e.clientY);
          const factor = 1 + (dy / 220);
          s.scale = clampScale(startScale * factor);
          applyTransformB(elNode, s);
          return;
        }

        if (rotateMode) {
          const { cx, cy } = getCenter();
          const a = angleBetween({ x: cx, y: cy }, { x: e.clientX, y: e.clientY });
          s.rot = startRot + (a - startAngle);
          applyTransformB(elNode, s);
          return;
        }

        const x = e.clientX - host.left;
        const y = e.clientY - host.top;
        const clamped = clampToCanvasB(x, y, elNode);
        elNode.style.left = clamped.x + "px";
        elNode.style.top = clamped.y + "px";
        s.xPct = clamped.x / host.width;
        s.yPct = clamped.y / host.height;
      }

      function onUp(e) {
        dragging = false;
        rotateMode = false;
        scaleMode = false;
        elNode.releasePointerCapture?.(e.pointerId);
        elNode.style.cursor = "grab";
      }

      function onWheel(e) {
        e.preventDefault();
        e.stopPropagation();
        setActiveStickerB(s.id);
        const delta = -e.deltaY;
        const step = delta > 0 ? 1.08 : 0.92;
        s.scale = clampScale(s.scale * step);
        applyTransformB(elNode, s);
      }

      function onTouchStart(e) {
        if (e.touches.length === 2) {
          e.preventDefault();
          e.stopPropagation();
          setActiveStickerB(s.id);
          gestureActive = true;
          const p1 = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          const p2 = { x: e.touches[1].clientX, y: e.touches[1].clientY };
          startDist = distBetween(p1, p2);
          startGestureAngle = angleBetween(p1, p2);
          startScale = s.scale;
          startRot = s.rot;
        }
      }

      function onTouchMove(e) {
        if (!gestureActive || e.touches.length !== 2) return;
        e.preventDefault();
        const p1 = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        const p2 = { x: e.touches[1].clientX, y: e.touches[1].clientY };
        const d = distBetween(p1, p2);
        const a = angleBetween(p1, p2);
        const ratio = d / Math.max(1, startDist);
        s.scale = clampScale(startScale * ratio);
        s.rot = startRot + (a - startGestureAngle);
        applyTransformB(elNode, s);
      }

      function onTouchEnd(e) {
        if (e.touches.length < 2) gestureActive = false;
      }

      elNode.addEventListener("pointerdown", onDown);
      window.addEventListener("pointermove", onMove);
      window.addEventListener("pointerup", onUp);
      elNode.addEventListener("wheel", onWheel, { passive: false });
      elNode.addEventListener("touchstart", onTouchStart, { passive: false });
      elNode.addEventListener("touchmove", onTouchMove, { passive: false });
      elNode.addEventListener("touchend", onTouchEnd, { passive: true });

      elNode.addEventListener("dblclick", (e) => {
        e.preventDefault();
        e.stopPropagation();
        removeStickerB(s.id);
        if (activeStickerIdB === s.id) activeStickerIdB = null;
      });
    }

    function createStickerB(symbol) {
      const host = decorLayerB.getBoundingClientRect();
      const id = "st_" + Math.random().toString(16).slice(2);
      const baseSize = Number(stickerSizeB.value || 34);
      const s = { id, symbol, xPct: 0.50, yPct: 0.50, rot: 0, scale: 1 };
      stickersB.push(s);

      const node = document.createElement("div");
      node.className = "sticker";
      node.dataset.id = id;
      node.textContent = symbol;
      node.style.fontSize = baseSize + "px";
      node.style.left = (s.xPct * host.width) + "px";
      node.style.top  = (s.yPct * host.height) + "px";
      applyTransformB(node, s);
      makeTransformableB(node, s);

      decorLayerB.appendChild(node);
      setActiveStickerB(id);
      softChime("place");
    }

    placeStickerBtnB.addEventListener("click", () => {
      const sym = stickerSelectB.value || "ü©∑";
      createStickerB(sym);
    });

    clearStickersBtnB.addEventListener("click", () => {
      stickersB.length = 0;
      decorLayerB.innerHTML = "";
      activeStickerIdB = null;
      softChime("gate");
    });

    decorLayerB.addEventListener("pointerdown", (e) => {
      if (e.target === decorLayerB) {
        activeStickerIdB = null;
        decorLayerB.querySelectorAll(".sticker").forEach(elm => (elm.style.outline = "none"));
      }
    });

    window.addEventListener("keydown", (e) => {
      if (!activeStickerIdB) return;
      if (e.key === "Backspace" || e.key === "Delete") {
        removeStickerB(activeStickerIdB);
        activeStickerIdB = null;
      }
    });

    function reflowStickersB() {
      const host = decorLayerB.getBoundingClientRect();
      stickersB.forEach(s => {
        const node = decorLayerB.querySelector(`[data-id="${s.id}"]`);
        if (!node) return;
        node.style.left = (s.xPct * host.width) + "px";
        node.style.top  = (s.yPct * host.height) + "px";
        applyTransformB(node, s);
      });
    }
    window.addEventListener("resize", () => reflowStickersB());

    updateAllSoundButtons();
  </script>
</body>
</html>


